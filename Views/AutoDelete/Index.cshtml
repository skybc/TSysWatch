@using TSysWatch
@model AutoDeleteFilePageViewModel
@{
    ViewData["Title"] = "è‡ªåŠ¨åˆ é™¤æ–‡ä»¶ç®¡ç†";
}

<h2>è‡ªåŠ¨åˆ é™¤æ–‡ä»¶ç®¡ç†</h2>

<div class="row">
    <div class="col-12 mb-3">
        <button type="button" class="btn btn-primary" id="downloadRecordsBtn">
            <i class="fa fa-download"></i> ğŸ“¥ ä¸‹è½½åˆ é™¤è®°å½•
        </button>
    </div>
</div>

<!-- ä¸‹è½½å†å²è®°å½•å¼¹æ¡† -->
<div id="downloadModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ä¸‹è½½åˆ é™¤è®°å½•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="startDate" class="form-label">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="startDate" />
                </div>

                <div class="mb-3">
                    <label for="endDate" class="form-label">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" class="form-control" id="endDate" />
                </div>

                <div class="mb-3">
                    <button type="button" class="btn btn-primary w-100" id="loadFilesBtn">æŸ¥è¯¢æ–‡ä»¶</button>
                </div>

                <div id="filesList" class="alert alert-info">
                    <small>æŸ¥è¯¢ååœ¨æ­¤æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨...</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="downloadBtn">ä¸‹è½½é€‰ä¸­èŒƒå›´</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h4>æ·»åŠ /ç¼–è¾‘é…ç½®</h4>
            </div>
            <div class="card-body">
                <form id="configForm">
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label">é©±åŠ¨å™¨å­—æ¯ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="driveLetter" placeholder="C:" required>
                            <small class="text-muted">ä¾‹å¦‚: C:, D:, E:</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">åˆ é™¤ç›®å½• <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="deleteDirectories" placeholder="C:\temp,C:\logs" required>
                            <small class="text-muted">å¤šä¸ªç›®å½•ç”¨é€—å·åˆ†éš”</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">å¼€å§‹åˆ é™¤(GB) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="startDeleteSizeGB" value="5.0" step="0.1" required>
                            <small class="text-muted">å‰©ä½™ç©ºé—´é˜ˆå€¼</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">åœæ­¢åˆ é™¤(GB) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="stopDeleteSizeGB" value="10.0" step="0.1" required>
                            <small class="text-muted">åœæ­¢åˆ é™¤é˜ˆå€¼</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">æ—¶é—´é˜ˆå€¼(å¤©)</label>
                            <input type="number" class="form-control" id="startDeleteFileDays" value="30" min="0">
                            <small class="text-muted">0è¡¨ç¤ºä¸é™åˆ¶</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-2">
                            <label class="form-label">é€»è¾‘æ¨¡å¼ <span class="text-danger">*</span></label>
                            <select class="form-select" id="logicMode">
                                <option value="OR">OR (æˆ–)</option>
                                <option value="AND">AND (ä¸”)</option>
                            </select>
                        </div>
                        <div class="col-md-10">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">é‡ç½®</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row" id="notificationArea"></div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>å½“å‰é…ç½®åˆ—è¡¨</h4>
            </div>
            <div class="card-body">
                <div id="configList">
                    <partial name="_ConfigList" model="Model.Configs" />
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4>ç£ç›˜çŠ¶æ€</h4>
            </div>
            <div class="card-body">
                <div id="driveList">
                    <partial name="_DrivesList" model="Model.Drives" />
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4>é…ç½®è¯´æ˜</h4>
            </div>
            <div class="card-body">
                <h6>é…ç½®æ–‡ä»¶æ ¼å¼ï¼š</h6>
                <p><strong>é…ç½®å­˜å‚¨ä½ç½®</strong>: <code>config/AutoDeleteFile.json</code></p>
                <p><strong>æ ¼å¼</strong>: JSON æ ¼å¼ï¼Œæ”¯æŒç¼–è¾‘å™¨ç›´æ¥ä¿®æ”¹æˆ–é€šè¿‡æœ¬ç•Œé¢ç®¡ç†</p>

                <h6>é…ç½®é¡¹è¯´æ˜ï¼š</h6>
                <ul class="small">
                    <li><strong>é©±åŠ¨å™¨å­—æ¯</strong>: ç£ç›˜é©±åŠ¨å™¨æ ‡è¯†ï¼Œå¦‚ C:, D:</li>
                    <li><strong>åˆ é™¤ç›®å½•</strong>: å¤šä¸ªç›®å½•ç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚: C:\temp,C:\logs</li>
                    <li><strong>å¼€å§‹åˆ é™¤</strong>: ç£ç›˜å‰©ä½™ç©ºé—´ä½äºæ­¤å€¼æ—¶å¼€å§‹åˆ é™¤</li>
                    <li><strong>åœæ­¢åˆ é™¤</strong>: ç£ç›˜å‰©ä½™ç©ºé—´è¾¾åˆ°æ­¤å€¼æ—¶åœæ­¢åˆ é™¤</li>
                    <li><strong>æ—¶é—´é˜ˆå€¼</strong>: åªåˆ é™¤è¶…è¿‡Nå¤©çš„æ–‡ä»¶ï¼Œ0è¡¨ç¤ºä¸é™åˆ¶æ—¶é—´</li>
                    <li><strong>é€»è¾‘æ¨¡å¼</strong>:
                        <ul>
                            <li><strong>OR</strong>: æ»¡è¶³å®¹é‡æˆ–æ—¶é—´æ¡ä»¶ä¹‹ä¸€å³å¯åˆ é™¤</li>
                            <li><strong>AND</strong>: å¿…é¡»åŒæ—¶æ»¡è¶³å®¹é‡å’Œæ—¶é—´æ¡ä»¶æ‰åˆ é™¤</li>
                        </ul>
                    </li>
                </ul>

                <h6>åˆ é™¤è®°å½•ï¼š</h6>
                <p>æ‰€æœ‰åˆ é™¤æ“ä½œéƒ½ä¼šè®°å½•åˆ° <code>wwwroot/record/auto_delete/yyyy/MM/yyyyMMdd.txt</code> æ–‡ä»¶ä¸­</p>
            </div>
        </div>
    </div>
</div>

<script>
let editingDriveLetter = null;
let downloadModal = null;

document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–ä¸‹è½½å¼¹æ¡†
    downloadModal = new bootstrap.Modal(document.getElementById('downloadModal'), {
        keyboard: false
    });

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;

    // ä¸‹è½½è®°å½•æŒ‰é’®
    document.getElementById('downloadRecordsBtn').addEventListener('click', function() {
        downloadModal.show();
    });

    // æŸ¥è¯¢æ–‡ä»¶æŒ‰é’®
    document.getElementById('loadFilesBtn').addEventListener('click', function() {
        loadDeleteRecordFiles();
    });

    // ä¸‹è½½æŒ‰é’®
    document.getElementById('downloadBtn').addEventListener('click', function() {
        downloadDeleteRecords();
    });

    // ä½¿ç”¨å§”æ‰˜äº‹ä»¶ç›‘å¬ï¼Œå¤„ç†ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®
    document.addEventListener('click', function(event) {
        const button = event.target;
        
        if (button.getAttribute('data-action') === 'edit') {
            event.preventDefault();
            editConfig(event);
        } else if (button.getAttribute('data-action') === 'delete') {
            event.preventDefault();
            deleteConfigWithConfirm(event);
        }
    });
});

/**
 * åŠ è½½åˆ é™¤è®°å½•æ–‡ä»¶åˆ—è¡¨
 */
function loadDeleteRecordFiles() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
        return;
    }

    fetch(`/AutoDelete/GetDeleteRecordFiles?startDate=${startDate}&endDate=${endDate}`)
        .then(response => response.json())
        .then(data => {
            const filesList = document.getElementById('filesList');
            if (data.files && data.files.length > 0) {
                let html = '<table class="table table-sm"><tbody>';
                data.files.forEach(file => {
                    html += `<tr>
                        <td>${file.fileName}</td>
                        <td class="text-end">${formatFileSize(file.size)}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                filesList.innerHTML = html;
                filesList.className = 'alert alert-success';
            } else {
                filesList.innerHTML = '<small style="color: #856404;">æ—¥æœŸèŒƒå›´å†…æ²¡æœ‰è®°å½•æ–‡ä»¶</small>';
                filesList.className = 'alert alert-warning';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('filesList').innerHTML = '<small style="color: #721c24;">é”™è¯¯: ' + error.message + '</small>';
            document.getElementById('filesList').className = 'alert alert-danger';
        });
}

/**
 * ä¸‹è½½åˆ é™¤è®°å½•
 */
function downloadDeleteRecords() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
        return;
    }

    window.location.href = `/AutoDelete/DownloadDeleteRecords?startDate=${startDate}&endDate=${endDate}`;
}

/**
 * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
 */
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}


/**
 * åˆ·æ–°é…ç½®å’Œé©±åŠ¨å™¨åˆ—è¡¨
 */
function refreshConfigs() {
    refreshConfigsList();
    refreshDrivesList();
}

/**
 * åˆ·æ–°é…ç½®åˆ—è¡¨
 */
function refreshConfigsList() {
    fetch('/AutoDelete/GetConfigsHtml')
        .then(response => response.text())
        .then(html => {
            document.getElementById('configList').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('configList').innerHTML = '<p class="text-danger">ç½‘ç»œé”™è¯¯: ' + error.message + '</p>';
        });
}

/**
 * åˆ·æ–°é©±åŠ¨å™¨åˆ—è¡¨
 */
function refreshDrivesList() {
    fetch('/AutoDelete/GetDrivesHtml')
        .then(response => response.text())
        .then(html => {
            document.getElementById('driveList').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('driveList').innerHTML = '<p class="text-danger">ç½‘ç»œé”™è¯¯: ' + error.message + '</p>';
        });
}

/**
 * ä¿å­˜é…ç½®
 */
function saveConfig() {
    const driveLetter = document.getElementById('driveLetter').value.trim();
    const deleteDirectories = document.getElementById('deleteDirectories').value.trim();
    const startDeleteSizeGB = parseFloat(document.getElementById('startDeleteSizeGB').value);
    const stopDeleteSizeGB = parseFloat(document.getElementById('stopDeleteSizeGB').value);
    const startDeleteFileDays = parseInt(document.getElementById('startDeleteFileDays').value);
    const logicMode = document.getElementById('logicMode').value;

    if (!driveLetter) {
        showNotification('é©±åŠ¨å™¨å­—æ¯ä¸èƒ½ä¸ºç©º', 'warning');
        return;
    }

    if (!deleteDirectories) {
        showNotification('åˆ é™¤ç›®å½•ä¸èƒ½ä¸ºç©º', 'warning');
        return;
    }

    if (startDeleteSizeGB >= stopDeleteSizeGB) {
        showNotification('å¼€å§‹åˆ é™¤å¤§å°å¿…é¡»å°äºåœæ­¢åˆ é™¤å¤§å°', 'warning');
        return;
    }

    const data = {
        driveLetter: driveLetter,
        deleteDirectories: deleteDirectories.split(',').map(d => d.trim()),
        startDeleteSizeGB: startDeleteSizeGB,
        stopDeleteSizeGB: stopDeleteSizeGB,
        startDeleteFileDays: startDeleteFileDays,
        logicMode: logicMode
    };

    fetch('/AutoDelete/SaveConfig', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification(result.message || 'é…ç½®ä¿å­˜æˆåŠŸ', 'success');
            resetForm();
            refreshConfigs();
        } else {
            showNotification(result.message || 'ä¿å­˜å¤±è´¥', 'danger');
        }
    })
    .catch(error => {
        showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
    });
}

/**
 * ç¼–è¾‘é…ç½®
 */
function editConfig(event) {
    const driveLetter = event.target.getAttribute('data-drive-letter');
    
    fetch('/AutoDelete/GetConfigs')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const config = data.configs.find(c => c.driveLetter === driveLetter);
                if (config) {
                    editingDriveLetter = config.driveLetter;
                    document.getElementById('driveLetter').value = config.driveLetter;
                    document.getElementById('deleteDirectories').value = config.deleteDirectories.join(',');
                    document.getElementById('startDeleteSizeGB').value = config.startDeleteSizeGB;
                    document.getElementById('stopDeleteSizeGB').value = config.stopDeleteSizeGB;
                    document.getElementById('startDeleteFileDays').value = config.startDeleteFileDays;
                    document.getElementById('logicMode').value = config.logicMode;
                    document.getElementById('driveLetter').disabled = true;
                    document.querySelector('button[onclick="saveConfig()"]').textContent = 'æ›´æ–°é…ç½®';
                    window.scrollTo(0, 0);
                }
            }
        })
        .catch(error => {
            showNotification('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'danger');
        });
}

/**
 * åˆ é™¤é…ç½®ï¼ˆå¸¦ç¡®è®¤ï¼‰
 */
function deleteConfigWithConfirm(event) {
    const driveLetter = event.target.getAttribute('data-drive-letter');
    
    if (!confirm(`ç¡®å®šè¦åˆ é™¤é©±åŠ¨å™¨ ${driveLetter} çš„é…ç½®å—ï¼Ÿ`)) {
        return;
    }

    const data = { driveLetter: driveLetter };

    fetch('/AutoDelete/DeleteConfig', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification(result.message, 'success');
            refreshConfigs();
        } else {
            showNotification('åˆ é™¤å¤±è´¥: ' + result.message, 'danger');
        }
    })
    .catch(error => {
        showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'danger');
    });
}

/**
 * é‡ç½®è¡¨å•
 */
function resetForm() {
    editingDriveLetter = null;
    document.getElementById('configForm').reset();
    document.getElementById('driveLetter').disabled = false;
    document.querySelector('button[onclick="saveConfig()"]').textContent = 'ä¿å­˜é…ç½®';
}

/**
 * æ˜¾ç¤ºé€šçŸ¥
 */
function showNotification(message, type) {
    const notificationArea = document.getElementById('notificationArea');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    notificationArea.innerHTML = '';
    notificationArea.appendChild(alertDiv);
    
    // 3ç§’åè‡ªåŠ¨éšè—
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>

<style>
.card {
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.card-header h4 {
    margin: 0;
    font-size: 1.1rem;
}

.table-responsive {
    margin-top: 10px;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.badge-info {
    background-color: #17a2b8;
}

.badge-warning {
    background-color: #ffc107;
    color: #212529;
}

.progress {
    background-color: #e9ecef;
}

.btn {
    margin-right: 5px;
}
</style>
