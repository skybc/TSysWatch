@using TSysWatch
@model AutoDeleteFilePageViewModel
@{
    ViewData["Title"] = "自动删除文件管理";
}

<h2>自动删除文件管理</h2>

<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h4>添加/编辑配置</h4>
            </div>
            <div class="card-body">
                <form id="configForm">
                    <div class="row">
                        <div class="col-md-2">
                            <label class="form-label">驱动器字母 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="driveLetter" placeholder="C:" required>
                            <small class="text-muted">例如: C:, D:, E:</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">删除目录 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="deleteDirectories" placeholder="C:\temp,C:\logs" required>
                            <small class="text-muted">多个目录用逗号分隔</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">开始删除(GB) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="startDeleteSizeGB" value="5.0" step="0.1" required>
                            <small class="text-muted">剩余空间阈值</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">停止删除(GB) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="stopDeleteSizeGB" value="10.0" step="0.1" required>
                            <small class="text-muted">停止删除阈值</small>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">时间阈值(天)</label>
                            <input type="number" class="form-control" id="startDeleteFileDays" value="30" min="0">
                            <small class="text-muted">0表示不限制</small>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-2">
                            <label class="form-label">逻辑模式 <span class="text-danger">*</span></label>
                            <select class="form-select" id="logicMode">
                                <option value="OR">OR (或)</option>
                                <option value="AND">AND (且)</option>
                            </select>
                        </div>
                        <div class="col-md-10">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-primary" onclick="saveConfig()">保存配置</button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">重置</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row" id="notificationArea"></div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>当前配置列表</h4>
            </div>
            <div class="card-body">
                <div id="configList">
                    <partial name="_ConfigList" model="Model.Configs" />
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4>磁盘状态</h4>
            </div>
            <div class="card-body">
                <div id="driveList">
                    <partial name="_DrivesList" model="Model.Drives" />
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h4>配置说明</h4>
            </div>
            <div class="card-body">
                <h6>配置文件格式：</h6>
                <p><strong>配置存储位置</strong>: <code>config/AutoDeleteFile.json</code></p>
                <p><strong>格式</strong>: JSON 格式，支持编辑器直接修改或通过本界面管理</p>

                <h6>配置项说明：</h6>
                <ul class="small">
                    <li><strong>驱动器字母</strong>: 磁盘驱动器标识，如 C:, D:</li>
                    <li><strong>删除目录</strong>: 多个目录用逗号分隔，例如: C:\temp,C:\logs</li>
                    <li><strong>开始删除</strong>: 磁盘剩余空间低于此值时开始删除</li>
                    <li><strong>停止删除</strong>: 磁盘剩余空间达到此值时停止删除</li>
                    <li><strong>时间阈值</strong>: 只删除超过N天的文件，0表示不限制时间</li>
                    <li><strong>逻辑模式</strong>:
                        <ul>
                            <li><strong>OR</strong>: 满足容量或时间条件之一即可删除</li>
                            <li><strong>AND</strong>: 必须同时满足容量和时间条件才删除</li>
                        </ul>
                    </li>
                </ul>

                <h6>删除记录：</h6>
                <p>所有删除操作都会记录到 <code>wwwroot/record/auto_delete/yyyy/MM/yyyyMMdd.txt</code> 文件中</p>
            </div>
        </div>
    </div>
</div>

<script>
let editingDriveLetter = null;

document.addEventListener('DOMContentLoaded', function() {
    // 使用委托事件监听，处理编辑和删除按钮
    document.addEventListener('click', function(event) {
        const button = event.target;
        
        if (button.getAttribute('data-action') === 'edit') {
            event.preventDefault();
            editConfig(event);
        } else if (button.getAttribute('data-action') === 'delete') {
            event.preventDefault();
            deleteConfigWithConfirm(event);
        }
    });
});

/**
 * 刷新配置和驱动器列表
 */
function refreshConfigs() {
    refreshConfigsList();
    refreshDrivesList();
}

/**
 * 刷新配置列表
 */
function refreshConfigsList() {
    fetch('/AutoDelete/GetConfigsHtml')
        .then(response => response.text())
        .then(html => {
            document.getElementById('configList').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('configList').innerHTML = '<p class="text-danger">网络错误: ' + error.message + '</p>';
        });
}

/**
 * 刷新驱动器列表
 */
function refreshDrivesList() {
    fetch('/AutoDelete/GetDrivesHtml')
        .then(response => response.text())
        .then(html => {
            document.getElementById('driveList').innerHTML = html;
        })
        .catch(error => {
            document.getElementById('driveList').innerHTML = '<p class="text-danger">网络错误: ' + error.message + '</p>';
        });
}

/**
 * 保存配置
 */
function saveConfig() {
    const driveLetter = document.getElementById('driveLetter').value.trim();
    const deleteDirectories = document.getElementById('deleteDirectories').value.trim();
    const startDeleteSizeGB = parseFloat(document.getElementById('startDeleteSizeGB').value);
    const stopDeleteSizeGB = parseFloat(document.getElementById('stopDeleteSizeGB').value);
    const startDeleteFileDays = parseInt(document.getElementById('startDeleteFileDays').value);
    const logicMode = document.getElementById('logicMode').value;

    if (!driveLetter) {
        showNotification('驱动器字母不能为空', 'warning');
        return;
    }

    if (!deleteDirectories) {
        showNotification('删除目录不能为空', 'warning');
        return;
    }

    if (startDeleteSizeGB >= stopDeleteSizeGB) {
        showNotification('开始删除大小必须小于停止删除大小', 'warning');
        return;
    }

    const data = {
        driveLetter: driveLetter,
        deleteDirectories: deleteDirectories.split(',').map(d => d.trim()),
        startDeleteSizeGB: startDeleteSizeGB,
        stopDeleteSizeGB: stopDeleteSizeGB,
        startDeleteFileDays: startDeleteFileDays,
        logicMode: logicMode
    };

    fetch('/AutoDelete/SaveConfig', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification(result.message || '配置保存成功', 'success');
            resetForm();
            refreshConfigs();
        } else {
            showNotification(result.message || '保存失败', 'danger');
        }
    })
    .catch(error => {
        showNotification('网络错误: ' + error.message, 'danger');
    });
}

/**
 * 编辑配置
 */
function editConfig(event) {
    const driveLetter = event.target.getAttribute('data-drive-letter');
    
    fetch('/AutoDelete/GetConfigs')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const config = data.configs.find(c => c.driveLetter === driveLetter);
                if (config) {
                    editingDriveLetter = config.driveLetter;
                    document.getElementById('driveLetter').value = config.driveLetter;
                    document.getElementById('deleteDirectories').value = config.deleteDirectories.join(',');
                    document.getElementById('startDeleteSizeGB').value = config.startDeleteSizeGB;
                    document.getElementById('stopDeleteSizeGB').value = config.stopDeleteSizeGB;
                    document.getElementById('startDeleteFileDays').value = config.startDeleteFileDays;
                    document.getElementById('logicMode').value = config.logicMode;
                    document.getElementById('driveLetter').disabled = true;
                    document.querySelector('button[onclick="saveConfig()"]').textContent = '更新配置';
                    window.scrollTo(0, 0);
                }
            }
        })
        .catch(error => {
            showNotification('加载配置失败: ' + error.message, 'danger');
        });
}

/**
 * 删除配置（带确认）
 */
function deleteConfigWithConfirm(event) {
    const driveLetter = event.target.getAttribute('data-drive-letter');
    
    if (!confirm(`确定要删除驱动器 ${driveLetter} 的配置吗？`)) {
        return;
    }

    const data = { driveLetter: driveLetter };

    fetch('/AutoDelete/DeleteConfig', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification(result.message, 'success');
            refreshConfigs();
        } else {
            showNotification('删除失败: ' + result.message, 'danger');
        }
    })
    .catch(error => {
        showNotification('网络错误: ' + error.message, 'danger');
    });
}

/**
 * 重置表单
 */
function resetForm() {
    editingDriveLetter = null;
    document.getElementById('configForm').reset();
    document.getElementById('driveLetter').disabled = false;
    document.querySelector('button[onclick="saveConfig()"]').textContent = '保存配置';
}

/**
 * 显示通知
 */
function showNotification(message, type) {
    const notificationArea = document.getElementById('notificationArea');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    notificationArea.innerHTML = '';
    notificationArea.appendChild(alertDiv);
    
    // 3秒后自动隐藏
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>

<style>
.card {
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.card-header h4 {
    margin: 0;
    font-size: 1.1rem;
}

.table-responsive {
    margin-top: 10px;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.badge-info {
    background-color: #17a2b8;
}

.badge-warning {
    background-color: #ffc107;
    color: #212529;
}

.progress {
    background-color: #e9ecef;
}

.btn {
    margin-right: 5px;
}
</style>
