@model TSysWatch.Models.CpuCoreIndexViewModel

@{
    ViewData["Title"] = "CPU 核心数管理器";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">CPU 核心数管理器</h1>
            
            @if (ViewBag.Error != null)
            {
                <div class="alert alert-danger">
                    <h4><i class="fas fa-exclamation-triangle"></i> 权限错误</h4>
                    <p><strong>@ViewBag.Error</strong></p>
                    @if (ViewBag.Solution != null)
                    {
                        <p class="mb-0">@ViewBag.Solution</p>
                    }
                    <hr>
                    <div class="d-flex justify-content-start">
                        <button type="button" class="btn btn-warning me-2" onclick="location.reload()">
                            <i class="fas fa-sync-alt"></i> 重新检查权限
                        </button>
                        <button type="button" class="btn btn-info" onclick="showPermissionHelp()">
                            <i class="fas fa-question-circle"></i> 权限帮助
                        </button>
                    </div>
                </div>
                
                <!-- 权限帮助信息 -->
                <div class="alert alert-info" id="permissionHelp" style="display: none;">
                    <h5>如何以管理员身份运行程序？</h5>
                    <ol>
                        <li>关闭当前程序</li>
                        <li>右键点击程序图标或可执行文件</li>
                        <li>在弹出菜单中选择 <strong>"以管理员身份运行"</strong></li>
                        <li>在 UAC 提示框中点击 <strong>"是"</strong></li>
                        <li>程序将以管理员权限重新启动</li>
                    </ol>
                    <p class="mb-0"><strong>注意：</strong> CPU 核心管理功能需要管理员权限才能修改进程的 CPU 亲和性设置。</p>
                </div>
                
                <script>
                function showPermissionHelp() {
                    const helpDiv = document.getElementById('permissionHelp');
                    helpDiv.style.display = helpDiv.style.display === 'none' ? 'block' : 'none';
                }
                </script>
                return;
            }

            <!-- 系统信息卡片 -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">CPU 核心数</h5>
                            <h2 class="text-primary">@Model.SystemInfo.ProcessorCount</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">管理员权限</h5>
                            <h2 class="@(Model.SystemInfo.IsAdministrator ? "text-success" : "text-danger")">
                                @(Model.SystemInfo.IsAdministrator ? "✓" : "✗")
                            </h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">默认核心数</h5>
                            <h2 class="text-info" id="defaultCoreCount">@Model.Config.DefaultCoreCount</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="card-title">扫描状态</h5>
                            <h2 class="@(Model.Config.Enabled ? "text-success" : "text-warning")">
                                @(Model.Config.Enabled ? "运行中" : "已停止")
                            </h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 操作按钮 -->
            <div class="mb-3">
                <button type="button" class="btn btn-primary" onclick="refreshProcesses()">
                    <i class="fas fa-sync-alt"></i> 刷新进程列表
                </button>
                <button type="button" class="btn btn-success" onclick="triggerScan()">
                    <i class="fas fa-search"></i> 手动扫描
                </button>
                <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#configModal">
                    <i class="fas fa-cog"></i> 系统配置
                </button>
                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#logsModal">
                    <i class="fas fa-list"></i> 操作日志
                </button>
            </div>

            <!-- 进程列表 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">进程列表</h5>
                    <small class="text-muted">点击核心数可以快速设置</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="processTable">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">PID</th>
                                    <th style="min-width: 150px;">进程名</th>
                                    <th style="width: 100px; text-align: center;">配置核心数</th>
                                    <th style="width: 100px; text-align: center;">当前核心数</th>
                                    <th style="width: 120px; text-align: center;">当前掩码</th>
                                    <th style="min-width: 200px;">核心绑定</th>
                                    <th style="width: 90px; text-align: center;">系统关键</th>
                                    <th style="width: 90px; text-align: center;">状态</th>
                                    <th style="width: 160px; text-align: center;">操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 配置模态框 -->
<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-cogs me-2"></i>CPU 核心管理配置
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 配置导航选项卡 -->
                <ul class="nav nav-tabs mb-4" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                            <i class="fas fa-sliders-h me-1"></i>基本设置
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="core-count-tab" data-bs-toggle="tab" data-bs-target="#core-count" type="button" role="tab">
                            <i class="fas fa-hashtag me-1"></i>核心数量映射
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="core-binding-tab" data-bs-toggle="tab" data-bs-target="#core-binding" type="button" role="tab">
                            <i class="fas fa-link me-1"></i>核心绑定映射
                        </button>
                    </li>
                </ul>

                <!-- 配置内容 -->
                <div class="tab-content" id="configTabContent">
                    <!-- 基本设置 -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-cog me-2"></i>系统配置</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">默认核心数</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text"><i class="fas fa-microchip"></i></span>
                                                        <input type="number" class="form-control" id="configDefaultCoreCount" 
                                                               min="1" max="@Model.SystemInfo.ProcessorCount">
                                                        <span class="input-group-text">/ @Model.SystemInfo.ProcessorCount</span>
                                                    </div>
                                                    <div class="form-text">新进程的默认CPU核心数量</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label fw-bold">扫描间隔</label>
                                                    <div class="input-group">
                                                        <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                                        <input type="number" class="form-control" id="configScanInterval" min="1">
                                                        <span class="input-group-text">秒</span>
                                                    </div>
                                                    <div class="form-text">自动扫描和应用配置的时间间隔</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="configEnabled">
                                            <label class="form-check-label fw-bold" for="configEnabled">
                                                <i class="fas fa-power-off me-2"></i>启用自动扫描
                                            </label>
                                            <div class="form-text">开启后将定期扫描进程并自动应用核心配置</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>系统信息</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>CPU 核心数：</span>
                                            <span class="badge bg-primary fs-6">@Model.SystemInfo.ProcessorCount</span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span>管理员权限：</span>
                                            <span class="badge @(Model.SystemInfo.IsAdministrator ? "bg-success" : "bg-danger") fs-6">
                                                @(Model.SystemInfo.IsAdministrator ? "已获得" : "未获得")
                                            </span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>配置文件：</span>
                                            <small class="text-muted">CpuCoreManager.ini</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 系统配置 -->
                    <div class="tab-pane fade" id="settings" role="tabpanel">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-cog me-2"></i>系统配置</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">默认核心数</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-microchip"></i></span>
                                        <input type="number" class="form-control" id="configDefaultCoreCount" 
                                               min="1" max="@Model.SystemInfo.ProcessorCount">
                                        <span class="input-group-text">/ @Model.SystemInfo.ProcessorCount</span>
                                    </div>
                                    <div class="form-text">新进程的默认CPU核心数量</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">扫描间隔</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                        <input type="number" class="form-control" id="configScanInterval" min="1">
                                        <span class="input-group-text">秒</span>
                                    </div>
                                    <div class="form-text">自动扫描和应用配置的时间间隔</div>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="configEnabled">
                                    <label class="form-check-label fw-bold" for="configEnabled">
                                        <i class="fas fa-power-off me-2"></i>启用自动扫描
                                    </label>
                                    <div class="form-text">开启后将定期扫描进程并自动应用核心配置</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 核心数量映射 -->
                    <div class="tab-pane fade" id="core-count" role="tabpanel">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-hashtag me-2"></i>进程名核心数量映射</h6>
                                <span class="badge bg-secondary" id="coreCountMappingCount">0 项</span>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info border-0">
                                    <div class="d-flex">
                                        <i class="fas fa-lightbulb me-3 mt-1"></i>
                                        <div>
                                            <strong>核心数量设置：</strong>为指定进程名设置使用的CPU核心数量。<br>
                                            <small class="text-muted">例如：chrome -> 4 表示Chrome浏览器使用4个CPU核心</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 添加映射表单 -->
                                <div class="row g-3 align-items-end mb-4">
                                    <div class="col-md-5">
                                        <label class="form-label">进程名</label>
                                        <input type="text" class="form-control" id="newProcessName" 
                                               placeholder="如: chrome, firefox, notepad">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">核心数量</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="newProcessCores" 
                                                   min="1" max="@Model.SystemInfo.ProcessorCount" placeholder="核心数">
                                            <span class="input-group-text">核心</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" class="btn btn-primary w-100" onclick="addProcessMapping()">
                                            <i class="fas fa-plus me-1"></i>添加映射
                                        </button>
                                    </div>
                                </div>

                                <!-- 映射列表 -->
                                <div id="processMappings"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 核心绑定映射 -->
                    <div class="tab-pane fade" id="core-binding" role="tabpanel">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-link me-2"></i>进程名核心绑定映射</h6>
                                <div>
                                    <span class="badge bg-success me-2" id="coreBindingMappingCount">0 项</span>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="showCoreBindingHelp()">
                                        <i class="fas fa-question-circle"></i> 使用说明
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-success border-0">
                                    <div class="d-flex">
                                        <i class="fas fa-star me-3 mt-1"></i>
                                        <div>
                                            <strong>核心绑定设置：</strong>为指定进程名绑定到具体的CPU核心。<br>
                                            <small class="text-muted">
                                                优先级高于核心数量设置。格式：0,2,4 表示绑定到第0、2、4个CPU核心
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- 核心绑定帮助 -->
                                <div class="alert alert-light border" id="coreBindingHelp" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-gamepad me-2"></i>游戏优化示例：</h6>
                                            <ul class="list-unstyled">
                                                <li class="mb-1">
                                                    <code>game.exe</code> → <span class="badge bg-success">0,2,4,6</span>
                                                    <small class="text-muted d-block">主游戏使用性能核心</small>
                                                </li>
                                                <li class="mb-1">
                                                    <code>steam.exe</code> → <span class="badge bg-info">1,3</span>
                                                    <small class="text-muted d-block">游戏平台使用后台核心</small>
                                                </li>
                                            </ul>
                                            
                                            <h6><i class="fas fa-code me-2"></i>开发环境示例：</h6>
                                            <ul class="list-unstyled">
                                                <li class="mb-1">
                                                    <code>code.exe</code> → <span class="badge bg-success">0,1,2,3</span>
                                                    <small class="text-muted d-block">IDE使用多核心</small>
                                                </li>
                                                <li class="mb-1">
                                                    <code>node.exe</code> → <span class="badge bg-info">4,5</span>
                                                    <small class="text-muted d-block">编译工具独立核心</small>
                                                </li>
                                            </ul>
                                        </div>
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-video me-2"></i>多媒体优化示例：</h6>
                                            <ul class="list-unstyled">
                                                <li class="mb-1">
                                                    <code>ffmpeg.exe</code> → <span class="badge bg-success">0,2,4,6</span>
                                                    <small class="text-muted d-block">视频编码专用核心</small>
                                                </li>
                                                <li class="mb-1">
                                                    <code>vlc.exe</code> → <span class="badge bg-info">1,3</span>
                                                    <small class="text-muted d-block">播放器使用独立核心</small>
                                                </li>
                                            </ul>

                                            <h6><i class="fas fa-globe me-2"></i>浏览器优化示例：</h6>
                                            <ul class="list-unstyled">
                                                <li class="mb-1">
                                                    <code>chrome.exe</code> → <span class="badge bg-success">0,1</span>
                                                    <small class="text-muted d-block">主浏览器</small>
                                                </li>
                                                <li class="mb-1">
                                                    <code>firefox.exe</code> → <span class="badge bg-info">2,3</span>
                                                    <small class="text-muted d-block">备用浏览器</small>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="alert alert-warning mt-3 mb-0">
                                        <small>
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>重要提示：</strong>核心索引从0开始，最大值为 @(Model.SystemInfo.ProcessorCount - 1)。
                                            合理分配核心可以避免进程间干扰，提升系统性能。
                                        </small>
                                    </div>
                                </div>

                                <!-- 添加绑定表单 -->
                                <div class="row g-3 align-items-end mb-4">
                                    <div class="col-md-4">
                                        <label class="form-label">进程名</label>
                                        <input type="text" class="form-control" id="newBindingProcessName" 
                                               placeholder="如: chrome, game, ffmpeg">
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label">核心索引列表</label>
                                        <input type="text" class="form-control" id="newBindingCores" 
                                               placeholder="如: 0,2,4 或 1,3,5,7">
                                        <div class="form-text">用逗号分隔，范围: 0-@(Model.SystemInfo.ProcessorCount - 1)</div>
                                    </div>
                                    <div class="col-md-3">
                                        <button type="button" class="btn btn-success w-100" onclick="addProcessBindingMapping()">
                                            <i class="fas fa-link me-1"></i>添加绑定
                                        </button>
                                    </div>
                                </div>

                                <!-- 快速选择核心 -->
                                <div class="card bg-light border-0 mb-4">
                                    <div class="card-body py-2">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <small class="text-muted">快速生成核心索引：</small>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary" onclick="quickFillCores('all')">
                                                    全部核心 (0-@(Model.SystemInfo.ProcessorCount - 1))
                                                </button>
                                                <button type="button" class="btn btn-outline-info" onclick="quickFillCores('even')">
                                                    偶数核心
                                                </button>
                                                <button type="button" class="btn btn-outline-warning" onclick="quickFillCores('odd')">
                                                    奇数核心
                                                </button>
                                                <button type="button" class="btn btn-outline-success" onclick="quickFillCores('performance')">
                                                    性能核心 (0,2,4,6)
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 绑定映射列表 -->
                                <div id="processBindingMappings"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <button type="button" class="btn btn-outline-info" onclick="validateConfig()">
                            <i class="fas fa-check-circle me-1"></i>验证配置
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="applyConfigToAll()">
                            <i class="fas fa-play me-1"></i>立即应用
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>取消
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveConfig()">
                            <i class="fas fa-save me-1"></i>保存配置
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 日志模态框 -->
<div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">操作日志</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>PID</th>
                                <th>进程名</th>
                                <th>类型</th>
                                <th>旧掩码</th>
                                <th>新掩码</th>
                                <th>核心绑定</th>
                                <th>成功</th>
                                <th>原因</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
let currentConfig = @Html.Raw(Json.Serialize(Model.Config));
let currentProcesses = @Html.Raw(Json.Serialize(Model.Processes));

$(document).ready(function() {
    loadProcesses();
    loadConfig();
    startAutoRefresh();
});

function loadProcesses() {
    $.get('/api/cpucore/processes', function(response) {
        if (response.success) {
            currentProcesses = response.data;
            renderProcessTable();
        } else {
            showAlert('danger', '加载进程列表失败: ' + response.message);
        }
    });
}

function renderProcessTable() {
    const tbody = $('#processTable tbody');
    tbody.empty();
    
    currentProcesses.forEach(process => {
        // 核心绑定显示优化
        let coreBindingDisplay = '';
        if (process.configuredCoreBinding) {
            const cores = process.configuredCoreBinding.split(',');
            coreBindingDisplay = `
                <div class="mb-1">
                    <span class="badge bg-success me-1">
                        <i class="fas fa-link me-1"></i>绑定模式
                    </span>
                </div>
                <div class="d-flex flex-wrap gap-1">
                    ${cores.map(core => `<span class="badge bg-info">${core}</span>`).join('')}
                </div>
            `;
        } else {
            coreBindingDisplay = `
                <span class="badge bg-secondary">
                    <i class="fas fa-hashtag me-1"></i>数量模式
                </span>
            `;
        }
        
        // 当前核心显示优化
        let currentCoresDisplay = '';
        if (process.currentBoundCores && process.currentBoundCores.length > 0) {
            currentCoresDisplay = `
                <div class="d-flex flex-wrap gap-1">
                    ${process.currentBoundCores.map(core => 
                        `<span class="badge bg-success">${core}</span>`
                    ).join('')}
                </div>
            `;
        } else {
            currentCoresDisplay = `<span class="badge bg-warning">未知</span>`;
        }
            
        const row = `
            <tr>
                <td class="text-center">
                    <span class="fw-bold">${process.processId}</span>
                </td>
                <td class="process-name-column">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-cube me-2 text-muted"></i>
                        <span class="fw-bold">${process.processName}</span>
                    </div>
                </td>
                <td class="text-center">
                    <span class="badge bg-primary cursor-pointer fs-6" onclick="quickSetCores(${process.processId}, ${process.configuredCoreCount})" title="点击快速设置">
                        ${process.configuredCoreCount}
                    </span>
                </td>
                <td class="text-center">
                    <span class="badge ${process.currentCoreCount === process.configuredCoreCount ? 'bg-success' : 'bg-warning'} fs-6">
                        ${process.currentCoreCount}
                    </span>
                </td>
                <td class="text-center">
                    <code class="small">${process.currentAffinityMask}</code>
                </td>
                <td class="binding-column">
                    <div class="mb-1">
                        <strong class="small text-muted">配置:</strong>
                        ${coreBindingDisplay}
                    </div>
                    <div>
                        <strong class="small text-muted">当前:</strong>
                        ${currentCoresDisplay}
                    </div>
                </td>
                <td class="text-center">
                    ${process.isSystemCritical ? 
                        '<span class="badge bg-danger"><i class="fas fa-shield-alt me-1"></i>关键</span>' : 
                        '<span class="badge bg-secondary">普通</span>'
                    }
                </td>
                <td class="text-center">
                    <span class="badge ${process.status === 'Running' ? 'bg-success' : 'bg-warning'}">
                        <i class="fas ${process.status === 'Running' ? 'fa-play' : 'fa-pause'} me-1"></i>
                        ${process.status}
                    </span>
                </td>
                <td class="action-column">
                    <div class="action-buttons d-flex flex-column gap-1">
                        <button class="btn btn-outline-primary btn-sm" onclick="setCores(${process.processId})" title="设置核心数量">
                            <i class="fas fa-hashtag me-1"></i>设置数量
                        </button> 
                        <button class="btn btn-outline-info btn-sm" onclick="addToBindingMapping('${process.processName}')" title="添加到核心绑定映射">
                            <i class="fas fa-plus me-1"></i>加入映射
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

function quickSetCores(processId, currentCores) {
    const newCores = prompt(`为进程 ${processId} 设置核心数:`, currentCores);
    if (newCores && !isNaN(newCores) && newCores > 0) {
        setProcessCores(processId, parseInt(newCores));
    }
}

function setCores(processId) {
    const process = currentProcesses.find(p => p.processId === processId);
    if (!process) return;
    
    const newCores = prompt(`为进程 ${process.processName} (PID: ${processId}) 设置核心数:`, process.configuredCoreCount);
    if (newCores && !isNaN(newCores) && newCores > 0) {
        setProcessCores(processId, parseInt(newCores));
    }
}

function setProcessCores(processId, coreCount) {
    $.post(`/api/cpucore/process/${processId}/cores/${coreCount}`, function(response) {
        if (response.success) {
            showAlert('success', response.message);
            refreshProcesses();
        } else {
            showAlert('danger', response.message);
        }
    });
}

function refreshProcesses() {
    loadProcesses();
}

function triggerScan() {
    $.post('/api/cpucore/scan', function(response) {
        if (response.success) {
            showAlert('success', response.message);
            setTimeout(refreshProcesses, 1000);
        } else {
            showAlert('danger', response.message);
        }
    });
}

function loadConfig() {
    $.get('/api/cpucore/config', function(response) {
        if (response.success) {
            currentConfig = response.data;
            populateConfigForm();
        }
    });
}

function populateConfigForm() {
    $('#configDefaultCoreCount').val(currentConfig.defaultCoreCount);
    $('#configScanInterval').val(currentConfig.scanIntervalSeconds);
    $('#configEnabled').prop('checked', currentConfig.enabled);
    
    renderProcessMappings();
    renderProcessBindingMappings();
    updateMappingCounts();
}

function renderProcessMappings() {
    const container = $('#processMappings');
    container.empty();
    
    const mappings = currentConfig.processNameMapping || {};
    
    if (Object.keys(mappings).length === 0) {
        container.append(`
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <p class="mb-0">暂无进程名核心数量映射</p>
                <small>添加映射后，指定进程将使用设定的核心数量</small>
            </div>
        `);
        return;
    }
    
    for (const [processName, coreCount] of Object.entries(mappings)) {
        const item = `
            <div class="card mb-2 border-0 shadow-sm">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-cube me-3 text-primary"></i>
                            <div>
                                <span class="fw-bold">${processName}</span>
                                <span class="badge bg-primary ms-2">${coreCount} 核心</span>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeProcessMapping('${processName}')">
                            <i class="fas fa-trash me-1"></i>删除
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.append(item);
    }
}

function renderProcessBindingMappings() {
    const container = $('#processBindingMappings');
    container.empty();
    
    const bindings = currentConfig.processCoreBindingMapping || {};
    
    if (Object.keys(bindings).length === 0) {
        container.append(`
            <div class="text-center text-muted py-4">
                <i class="fas fa-link fa-2x mb-2"></i>
                <p class="mb-0">暂无进程名核心绑定映射</p>
                <small>添加绑定后，指定进程将固定使用设定的CPU核心</small>
            </div>
        `);
        return;
    }
    
    for (const [processName, coreBinding] of Object.entries(bindings)) {
        const cores = coreBinding.split(',').map(c => parseInt(c));
        const coreCount = cores.length;
        const item = `
            <div class="card mb-3 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-link me-3 text-success mt-1"></i>
                            <div>
                                <div class="mb-2">
                                    <span class="fw-bold fs-6">${processName}</span>
                                    <span class="badge bg-success ms-2">${coreCount} 核心绑定</span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted d-block mb-1">绑定到核心:</small>
                                    <div class="d-flex flex-wrap gap-1">
                                        ${cores.map(core => `<span class="badge bg-info">核心 ${core}</span>`).join('')}
                                    </div>
                                </div>
                                <div class="small text-muted">
                                    <i class="fas fa-code me-1"></i>配置值: <code>${coreBinding}</code>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group-vertical btn-group-sm">
                            <button type="button" class="btn btn-outline-primary mb-1" onclick="editProcessBindingMapping('${processName}', '${coreBinding}')">
                                <i class="fas fa-edit me-1"></i>编辑
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="removeProcessBindingMapping('${processName}')">
                                <i class="fas fa-trash me-1"></i>删除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        container.append(item);
    }
}

function updateMappingCounts() {
    const coreCountMappings = Object.keys(currentConfig.processNameMapping || {}).length;
    const coreBindingMappings = Object.keys(currentConfig.processCoreBindingMapping || {}).length;
    
    $('#coreCountMappingCount').text(`${coreCountMappings} 项`);
    $('#coreBindingMappingCount').text(`${coreBindingMappings} 项`);
}

function quickFillCores(type) {
    const processorCount = @Model.SystemInfo.ProcessorCount;
    let coreList = '';
    
    switch(type) {
        case 'all':
            coreList = Array.from({length: processorCount}, (_, i) => i).join(',');
            break;
        case 'even':
            coreList = Array.from({length: processorCount}, (_, i) => i).filter(i => i % 2 === 0).join(',');
            break;
        case 'odd':
            coreList = Array.from({length: processorCount}, (_, i) => i).filter(i => i % 2 === 1).join(',');
            break;
        case 'performance':
            coreList = Array.from({length: Math.min(8, processorCount)}, (_, i) => i).filter(i => i % 2 === 0).join(',');
            break;
    }
    
    $('#newBindingCores').val(coreList);
}

function addProcessMapping() {
    const processName = $('#newProcessName').val().trim();
    const coreCount = parseInt($('#newProcessCores').val());
    
    if (!processName || !coreCount || coreCount < 1) {
        showAlert('warning', '请输入有效的进程名和核心数');
        return;
    }
    
    currentConfig.processNameMapping[processName] = coreCount;
    renderProcessMappings();
    updateMappingCounts();
    
    $('#newProcessName').val('');
    $('#newProcessCores').val('');
    
    showAlert('success', `已添加核心数量映射: ${processName} -> ${coreCount} 核心`);
}

function removeProcessMapping(processName) {
    if (confirm(`确定要删除进程 "${processName}" 的核心数量映射吗？`)) {
        delete currentConfig.processNameMapping[processName];
        renderProcessMappings();
        updateMappingCounts();
        showAlert('info', `已删除核心数量映射: ${processName}`);
    }
}

function addProcessBindingMapping() {
    const processName = $('#newBindingProcessName').val().trim();
    const coreBinding = $('#newBindingCores').val().trim();
    
    if (!processName || !coreBinding) {
        showAlert('warning', '请输入有效的进程名和核心绑定');
        return;
    }
    
    // 验证核心绑定格式
    const cores = coreBinding.split(',').map(s => s.trim());
    const invalidCores = cores.filter(core => {
        const coreIndex = parseInt(core);
        return isNaN(coreIndex) || coreIndex < 0 || coreIndex >= @Model.SystemInfo.ProcessorCount;
    });
    
    if (invalidCores.length > 0) {
        showAlert('warning', `无效的核心索引: ${invalidCores.join(', ')}。有效范围: 0-${@Model.SystemInfo.ProcessorCount - 1}`);
        return;
    }
    
    // 检查重复的核心索引
    const uniqueCores = [...new Set(cores.map(c => parseInt(c)))].sort((a, b) => a - b);
    const normalizedBinding = uniqueCores.join(',');
    
    if (!currentConfig.processCoreBindingMapping) {
        currentConfig.processCoreBindingMapping = {};
    }
    
    currentConfig.processCoreBindingMapping[processName] = normalizedBinding;
    renderProcessBindingMappings();
    updateMappingCounts();
    
    $('#newBindingProcessName').val('');
    $('#newBindingCores').val('');
    
    showAlert('success', `已添加核心绑定映射: ${processName} -> 核心 ${normalizedBinding}`);
}

function removeProcessBindingMapping(processName) {
    if (confirm(`确定要删除进程 "${processName}" 的核心绑定映射吗？`)) {
        if (currentConfig.processCoreBindingMapping) {
            delete currentConfig.processCoreBindingMapping[processName];
            renderProcessBindingMappings();
            updateMappingCounts();
            showAlert('info', `已删除核心绑定映射: ${processName}`);
        }
    }
}

function editProcessBindingMapping(processName, currentBinding) {
    // 切换到核心绑定选项卡
    const bindingTab = new bootstrap.Tab(document.getElementById('core-binding-tab'));
    bindingTab.show();
    
    // 填充表单
    $('#newBindingProcessName').val(processName);
    $('#newBindingCores').val(currentBinding);
    
    // 聚焦到核心索引输入框
    setTimeout(() => {
        $('#newBindingCores').focus().select();
    }, 300);
}

// 当日志模态框显示时加载日志
$('#logsModal').on('show.bs.modal', function() {
    loadLogs();
});

function showAlert(type, message) {
    const alert = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('.container-fluid').prepend(alert);
    
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}

function setCoreBinding(processId) {
    const process = currentProcesses.find(p => p.processId === processId);
    if (!process) return;
    
    showCoreBindingModal(processId, process.processName, process.currentBoundCores || []);
}

function showCoreBindingModal(processId, processName, currentCores) {
    // 获取可用的CPU核心
    $.get('/api/cpucore/available-cores', function(response) {
        if (response.success) {
            const cores = response.data.cores;
            const totalCores = response.data.totalCores;
            
            // 创建核心选择模态框
            const modalHtml = `
                <div class="modal fade" id="coreBindingModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">
                                    <i class="fas fa-link me-2"></i>CPU 核心绑定设置
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info border-0 mb-4">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-info-circle me-3 fs-4"></i>
                                        <div>
                                            <strong>进程信息:</strong> ${processName} (PID: ${processId})<br>
                                            <small class="text-muted">选择要绑定的CPU核心，可以多选以提供更好的性能控制</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="card border-0 shadow-sm mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-microchip me-2"></i>CPU 核心选择
                                            <span class="badge bg-secondary ms-2" id="selectedCoreCount">0 / ${totalCores}</span>
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-2" id="coreSelection">
                                            ${cores.map(core => `
                                                <div class="col-md-3 col-sm-4 col-6">
                                                    <div class="form-check form-check-card">
                                                        <input class="form-check-input" type="checkbox" value="${core.index}" 
                                                               id="core${core.index}" ${currentCores.includes(core.index) ? 'checked' : ''}
                                                               onchange="updateSelectedCoreCount()">
                                                        <label class="form-check-label w-100 text-center py-2" for="core${core.index}">
                                                            <i class="fas fa-microchip d-block mb-1"></i>
                                                            <strong>核心 ${core.index}</strong>
                                                        </label>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>

                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-magic me-2"></i>快速选择
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex flex-wrap gap-2">
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectAllCores(true)">
                                                <i class="fas fa-check-double me-1"></i>全选
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAllCores(false)">
                                                <i class="fas fa-times me-1"></i>全不选
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="selectEvenCores()">
                                                <i class="fas fa-step-forward me-1"></i>偶数核心
                                            </button>
                                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="selectOddCores()">
                                                <i class="fas fa-step-backward me-1"></i>奇数核心
                                            </button>
                                            <button type="button" class="btn btn-outline-success btn-sm" onclick="selectPerformanceCores()">
                                                <i class="fas fa-bolt me-1"></i>性能核心 (0,2,4,6)
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div id="coreBindingPreview" class="mt-3" style="display: none;">
                                    <div class="alert alert-success border-0">
                                        <strong>
                                            <i class="fas fa-eye me-2"></i>绑定预览:
                                        </strong>
                                        <span id="previewText"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer bg-light">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>取消
                                </button>
                                <button type="button" class="btn btn-success" onclick="applyCoreBinding(${processId})" id="applyBindingBtn" disabled>
                                    <i class="fas fa-link me-1"></i>应用核心绑定
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除已存在的模态框
            $('#coreBindingModal').remove();
            $('body').append(modalHtml);
            
            // 添加核心选择卡片样式
            const style = `
                <style>
                .form-check-card {
                    position: relative;
                }
                .form-check-card .form-check-input {
                    position: absolute;
                    top: 0.5rem;
                    right: 0.5rem;
                    z-index: 2;
                }
                .form-check-card .form-check-label {
                    display: block;
                    padding: 1rem;
                    background-color: #f8f9fa;
                    border: 2px solid #dee2e6;
                    border-radius: 0.5rem;
                    cursor: pointer;
                    transition: all 0.2s ease-in-out;
                    text-align: center;
                }
                .form-check-card .form-check-label:hover {
                    background-color: #e9ecef;
                    border-color: #adb5bd;
                    transform: translateY(-1px);
                }
                .form-check-card .form-check-input:checked + .form-check-label {
                    background-color: #d1ecf1;
                    border-color: #17a2b8;
                    color: #0c5460;
                }
                .form-check-card .form-check-input:checked + .form-check-label i {
                    color: #17a2b8;
                }
                </style>
            `;
            $('head').append(style);
            
            $('#coreBindingModal').modal('show');
            updateSelectedCoreCount();
        } else {
            showAlert('danger', '获取CPU核心信息失败: ' + response.message);
        }
    });
}

function updateSelectedCoreCount() {
    const selectedCores = $('#coreSelection input[type="checkbox"]:checked');
    const totalCores = $('#coreSelection input[type="checkbox"]').length;
    const count = selectedCores.length;
    
    $('#selectedCoreCount').text(`${count} / ${totalCores}`);
    
    // 更新应用按钮状态
    $('#applyBindingBtn').prop('disabled', count === 0);
    
    // 更新预览
    if (count > 0) {
        const coreNumbers = [];
        selectedCores.each(function() {
            coreNumbers.push($(this).val());
        });
        $('#previewText').text(`核心 ${coreNumbers.join(', ')}`);
        $('#coreBindingPreview').show();
    } else {
        $('#coreBindingPreview').hide();
    }
}

function selectAllCores(select) {
    $('#coreSelection input[type="checkbox"]').prop('checked', select);
    updateSelectedCoreCount();
}

function selectEvenCores() {
    $('#coreSelection input[type="checkbox"]').each(function() {
        const coreIndex = parseInt($(this).val());
        $(this).prop('checked', coreIndex % 2 === 0);
    });
    updateSelectedCoreCount();
}

function selectOddCores() {
    $('#coreSelection input[type="checkbox"]').each(function() {
        const coreIndex = parseInt($(this).val());
        $(this).prop('checked', coreIndex % 2 === 1);
    });
    updateSelectedCoreCount();
}

function selectPerformanceCores() {
    const totalCores = $('#coreSelection input[type="checkbox"]').length;
    $('#coreSelection input[type="checkbox"]').prop('checked', false);
    
    // 选择偶数核心，最多8个
    const maxCores = Math.min(8, totalCores);
    for (let i = 0; i < maxCores; i += 2) {
        $(`#core${i}`).prop('checked', true);
    }
    
    updateSelectedCoreCount();
}

function applyCoreBinding(processId) {
    const selectedCores = [];
    $('#coreSelection input[type="checkbox"]:checked').each(function() {
        selectedCores.push(parseInt($(this).val()));
    });
    
    if (selectedCores.length === 0) {
        showAlert('warning', '请至少选择一个CPU核心');
        return;
    }
    
    // 禁用按钮防止重复提交
    $('#applyBindingBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>应用中...');

    const requestData = {
        processId: processId,
        coreIndices: selectedCores
    };
    
    $.ajax({
        url: `/api/cpucore/process/${processId}/binding`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(requestData),
        success: function(response) {
            if (response.success) {
                showAlert('success', `${response.message}<br><small>绑定到核心: ${selectedCores.join(', ')}</small>`);
                $('#coreBindingModal').modal('hide');
                refreshProcesses();
            } else {
                showAlert('danger', response.message);
                $('#applyBindingBtn').prop('disabled', false).html('<i class="fas fa-link me-1"></i>应用核心绑定');
            }
        },
        error: function(xhr, status, error) {
            showAlert('danger', '请求失败: ' + error);
            $('#applyBindingBtn').prop('disabled', false).html('<i class="fas fa-link me-1"></i>应用核心绑定');
        }
    });
}

function showCoreBindingHelp() {
    const helpDiv = document.getElementById('coreBindingHelp');
    if (helpDiv.style.display === 'none') {
        helpDiv.style.display = 'block';
        // 滚动到帮助区域
        helpDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } else {
        helpDiv.style.display = 'none';
    }
}

// 在进程表格中添加快速绑定功能
function addToBindingMapping(processName) {
    // 打开配置模态框
    $('#configModal').modal('show');
    
    // 切换到核心绑定选项卡
    setTimeout(() => {
        const bindingTab = new bootstrap.Tab(document.getElementById('core-binding-tab'));
        bindingTab.show();
        
        // 填充进程名
        $('#newBindingProcessName').val(processName);
        
        // 聚焦到核心索引输入框
        setTimeout(() => {
            $('#newBindingCores').focus();
            showAlert('info', `已为您填入进程名 "${processName}"，请设置要绑定的核心索引`);
        }, 300);
    }, 300);
}

function loadLogs() {
    $.get('/api/cpucore/logs?count=100', function(response) {
        if (response.success) {
            renderLogs(response.data);
        }
    });
}

function renderLogs(logs) {
    const tbody = $('#logsTableBody');
    tbody.empty();
    
    logs.forEach(log => {
        const settingTypeDisplay = log.settingType === 'CoreBinding' 
            ? '<span class="badge bg-success">核心绑定</span>'
            : '<span class="badge bg-primary">核心数量</span>';
            
        const coreBindingDisplay = log.coreBindingDetails 
            ? `<code>${log.coreBindingDetails}</code>`
            : '-';
            
        const row = `
            <tr>
                <td>${new Date(log.timestamp).toLocaleString()}</td>
                <td>${log.processId}</td>
                <td>${log.processName}</td>
                <td>${settingTypeDisplay}</td>
                <td><code>${log.oldAffinityMask}</code></td>
                <td><code>${log.newAffinityMask}</code></td>
                <td>${coreBindingDisplay}</td>
                <td>
                    <span class="badge ${log.success ? 'bg-success' : 'bg-danger'}">
                        ${log.success ? '成功' : '失败'}
                    </span>
                </td>
                <td>${log.reason}</td>
            </tr>
        `;
        tbody.append(row);
    });
}

function validateConfig() {
    // 更新当前配置
    currentConfig.defaultCoreCount = parseInt($('#configDefaultCoreCount').val());
    currentConfig.scanIntervalSeconds = parseInt($('#configScanInterval').val());
    currentConfig.enabled = $('#configEnabled').is(':checked');
    
    $.ajax({
        url: '/api/cpucore/config/validate',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(currentConfig),
        success: function(response) {
            if (response.success) {
                showConfigValidationResult(response.data);
            } else {
                showAlert('danger', '配置验证失败: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            showAlert('danger', '验证请求失败: ' + error);
        }
    });
}

function showConfigValidationResult(validation) {
    let resultHtml = '<div class="alert ';
    
    if (validation.errors.length > 0) {
        resultHtml += 'alert-danger';
    } else if (validation.warnings.length > 0) {
        resultHtml += 'alert-warning';
    } else {
        resultHtml += 'alert-success';
    }
    
    resultHtml += '"><h6>配置验证结果</h6>';
    
    if (validation.errors.length === 0 && validation.warnings.length === 0) {
        resultHtml += '<p><i class="fas fa-check-circle"></i> 配置验证通过，所有设置都有效！</p>';
    }
    
    if (validation.errors.length > 0) {
        resultHtml += '<h6 class="text-danger">错误:</h6><ul>';
        validation.errors.forEach(error => {
            resultHtml += `<li>${error}</li>`;
        });
        resultHtml += '</ul>';
    }
    
    if (validation.warnings.length > 0) {
        resultHtml += '<h6 class="text-warning">警告:</h6><ul>';
        validation.warnings.forEach(warning => {
            resultHtml += `<li>${warning}</li>`;
        });
        resultHtml += '</ul>';
    }
    
    if (validation.suggestions.length > 0) {
        resultHtml += '<h6 class="text-info">建议:</h6><ul>';
        validation.suggestions.forEach(suggestion => {
            resultHtml += `<li>${suggestion}</li>`;
        });
        resultHtml += '</ul>';
    }
    
    resultHtml += '</div>';
    
    // 移除之前的验证结果
    $('.config-validation-result').remove();
    
    // 添加新的验证结果
    $(resultHtml).addClass('config-validation-result').insertAfter('#processBindingMappings');
}

function applyConfigToAll() {
    if (!confirm('确定要立即将当前配置应用到所有匹配的进程吗？这将会修改正在运行的进程的CPU核心设置。')) {
        return;
    }
    
    $.ajax({
        url: '/api/cpucore/config/apply',
        method: 'POST',
        success: function(response) {
            if (response.success) {
                showAlert('success', response.message);
                // 刷新进程列表以显示更新后的状态
                setTimeout(() => {
                    refreshProcesses();
                }, 1000);
            } else {
                showAlert('danger', '应用配置失败: ' + response.message);
            }
        },
        error: function(xhr, status, error) {
            showAlert('danger', '请求失败: ' + error);
        }
    });
}

function saveConfig() {
    // 首先验证配置
    validateConfig();
    
    // 延迟保存，让用户看到验证结果
    setTimeout(() => {
        currentConfig.defaultCoreCount = parseInt($('#configDefaultCoreCount').val());
        currentConfig.scanIntervalSeconds = parseInt($('#configScanInterval').val());
        currentConfig.enabled = $('#configEnabled').is(':checked');
        
        $.ajax({
            url: '/api/cpucore/config',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(currentConfig),
            success: function(response) {
                if (response.success) {
                    showAlert('success', response.message + ' 配置将在下次扫描时自动应用到匹配的进程。');
                    $('#configModal').modal('hide');
                    $('#defaultCoreCount').text(currentConfig.defaultCoreCount);
                } else {
                    showAlert('danger', response.message);
                }
            },
            error: function(xhr, status, error) {
                showAlert('danger', '保存失败: ' + error);
            }
        });
    }, 500);
}

// 添加定时刷新功能
let autoRefreshInterval;

function startAutoRefresh() {
    stopAutoRefresh(); // 先停止现有的定时器
    autoRefreshInterval = setInterval(() => {
        refreshProcesses();
    }, 5000); // 每5秒刷新一次
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// 页面隐藏时停止自动刷新，显示时重新开始
$(document).on('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});
</script>
}

<style>
.cursor-pointer {
    cursor: pointer;
}

/* 进程表格优化 */
#processTable {
    font-size: 0.9rem;
    table-layout: fixed; /* 固定表格布局 */
    width: 100%;
}

#processTable th {
    background-color: #f8f9fa;
    font-weight: 600;
    font-size: 0.85rem;
    border-top: none;
    padding: 0.75rem 0.5rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#processTable td {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 操作列特殊处理 */
#processTable .action-column {
    white-space: normal !important;
    overflow: visible !important;
}

/* 核心绑定列特殊处理 */
#processTable .binding-column {
    white-space: normal !important;
    overflow: visible !important;
}

/* 进程名列允许换行 */
#processTable .process-name-column {
    white-space: normal !important;
    word-break: break-word;
}

/* 操作按钮优化 */
.action-buttons .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    min-width: 85px;
    text-align: left;
}

.action-buttons .btn i {
    width: 14px;
    text-align: center;
}

/* 配置模态框选项卡 */
.nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: #6c757d;
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    background-color: transparent;
    border-bottom-color: #0d6efd;
    color: #0d6efd;
    font-weight: 600;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #dee2e6;
    color: #495057;
}

/* 卡片组件美化 */
.card {
    transition: all 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-1px);
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1) !important;
}

/* 徽章美化 */
.badge {
    font-weight: 500;
    font-size: 0.75em;
}

.badge.fs-6 {
    font-size: 0.85rem !important;
}

/* 核心绑定显示优化 */
.core-binding-display {
    max-width: 200px;
}

.core-binding-display .badge {
    margin: 1px;
    font-size: 0.7rem;
}

/* 映射列表优化 */
.mapping-item {
    transition: all 0.2s ease-in-out;
}

.mapping-item:hover {
    background-color: #f8f9fa;
}

/* 帮助信息样式 */
.alert-light {
    background-color: #fefefe;
    border: 1px solid #dee2e6;
}

/* 快速操作按钮组 */
.quick-actions {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 0.5rem;
}

/* 系统信息卡片 */
.system-info-card .card-header {
    background: linear-gradient(135deg, #17a2b8, #138496);
}

/* 配置验证结果 */
.config-validation-result {
    animation: slideDown 0.3s ease-in-out;
}

@@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 响应式优化 */
@@media (max-width: 1200px) {
    #processTable {
        font-size: 0.85rem;
    }
    
    .action-buttons .btn {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        min-width: 75px;
    }
    
    #processTable th,
    #processTable td {
        padding: 0.5rem 0.3rem;
    }
}

@@media (max-width: 992px) {
    .modal-xl {
        max-width: 95%;
    }
    
    #processTable {
        font-size: 0.8rem;
    }
    
    .action-buttons .btn {
        font-size: 0.65rem;
        padding: 0.15rem 0.3rem;
        min-width: 70px;
    }
    
    .badge {
        font-size: 0.65em;
    }
}

@@media (max-width: 768px) {
    /* 移动端显示优化 */
    #processTable th:nth-child(4),
    #processTable td:nth-child(4),
    #processTable th:nth-child(5),
    #processTable td:nth-child(5) {
        display: none; /* 隐藏当前核心数和掩码列 */
    }
    
    .action-buttons {
        flex-direction: row !important;
        gap: 0.25rem !important;
    }
    
    .action-buttons .btn {
        font-size: 0.6rem;
        padding: 0.1rem 0.2rem;
        min-width: 50px;
    }
    
    .action-buttons .btn i {
        display: none; /* 移动端隐藏图标 */
    }
}

/* 表格滚动优化 */
.table-responsive {
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

/* 模态框头部美化 */
.modal-header.bg-primary {
    background: linear-gradient(135deg, #0d6efd, #0b5ed7) !important;
}

/* 选项卡内容区域 */
.tab-content {
    min-height: 400px;
}

/* 空状态样式 */
.empty-state {
    padding: 3rem 1rem;
    text-align: center;
    color: #6c757d;
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
</style>