@using TSysWatch
@model HardwareMonitorViewModel

<div class="hardware-monitor-container">
    <div class="hardware-header">
        <div class="header-content">
            <h1>âš™ï¸ ç¡¬ä»¶ç›‘æ§</h1>
            <div class="update-info">
                <span class="last-update">æœ€åæ›´æ–°: <span id="lastUpdateTime">åŠ è½½ä¸­...</span></span>
                <button class="refresh-btn" onclick="manualRefresh()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button class="btn-config" onclick="openConfigModal()">âš™ï¸ é…ç½®</button>
                <button class="btn-config" onclick="openDownloadModal()">ğŸ“¥ ä¸‹è½½è®°å½•</button>
            </div>
        </div>
    </div>

    <!-- é…ç½®å¼¹æ¡† -->
    <div id="configModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>å®šæ—¶è®°å½•é…ç½®</h2>
                <button class="modal-close" onclick="closeConfigModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <form id="recordingConfigForm">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enableTimedRecording" />
                            <span>å¯ç”¨å®šæ—¶è®°å½•</span>
                        </label>
                        <span class="help-text">å¯ç”¨åå°†å®šæœŸé‡‡é›†ç¡¬ä»¶æ•°æ®å¹¶ä¿å­˜ä¸ºCSVæ–‡ä»¶</span>
                    </div>

                    <div class="form-group" id="intervalGroup" style="display: none;">
                        <label for="recordingInterval">å®šæ—¶è®°å½•é—´éš”ï¼ˆç§’ï¼‰</label>
                        <div class="input-group">
                            <input type="number" id="recordingInterval" min="2" value="10" />
                            <span class="help-text">æœ€å°å€¼ä¸º2ç§’</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="csvPath">CSVæ–‡ä»¶å­˜å‚¨ç›®å½•</label>
                        <input type="text" id="csvPath" value="HardwareData" />
                        <span class="help-text">ç›¸å¯¹äºåº”ç”¨ç¨‹åºç›®å½•çš„è·¯å¾„</span>
                    </div>

                    <div class="form-group">
                        <label>é€‰æ‹©è¦è®°å½•çš„ä¼ æ„Ÿå™¨ç±»å‹</label>
                        <div class="sensor-selection">
                            <button type="button" class="btn-small" onclick="selectAllSensors()">å…¨é€‰</button>
                            <button type="button" class="btn-small" onclick="clearAllSensors()">å…¨ä¸é€‰</button>
                        </div>
                        <div class="sensor-types-grid">
                            @foreach (var sensorType in Model.AvailableSensorTypes)
                            {
                                <label class="checkbox-label">
                                    <input type="checkbox" name="sensorTypes" value="@sensorType" checked />
                                    @GetSensorTypeDisplay(sensorType)
                                </label>
                            }
                        </div>
                        <span class="help-text">ä¸é€‰æ‹©è¡¨ç¤ºè®°å½•æ‰€æœ‰ç±»å‹çš„ä¼ æ„Ÿå™¨</span>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-primary" onclick="saveRecordingConfig()">ä¿å­˜é…ç½®</button>
                        <button type="button" class="btn-secondary" onclick="closeConfigModal()">å…³é—­</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ä¸‹è½½å†å²è®°å½•å¼¹æ¡† -->
    <div id="downloadModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ä¸‹è½½ç¡¬ä»¶ç›‘æ§å†å²è®°å½•</h2>
                <button class="modal-close" onclick="closeDownloadModal()">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="startDate">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate" />
                </div>

                <div class="form-group">
                    <label for="endDate">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endDate" />
                </div>

                <div class="form-group">
                    <button type="button" class="btn-primary" onclick="loadCsvFiles()">æŸ¥è¯¢æ–‡ä»¶</button>
                </div>

                <div id="filesList" class="files-list"></div>

                <div class="form-actions">
                    <button type="button" class="btn-primary" onclick="downloadCsvZip()">ä¸‹è½½é€‰ä¸­èŒƒå›´</button>
                    <button type="button" class="btn-secondary" onclick="closeDownloadModal()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <div id="hardwareContent">
        @await Html.PartialAsync("_HardwareContent", Model)
    </div>
</div>

<style>
    .hardware-monitor-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    .hardware-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
        box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .hardware-header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .update-info {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .last-update {
        font-size: 0.95rem;
        opacity: 0.95;
    }

    #lastUpdateTime {
        font-weight: 500;
    }

    .refresh-btn, .btn-config {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .refresh-btn:hover, .btn-config:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .refresh-btn:active, .btn-config:active {
        transform: scale(0.98);
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        animation: fadeIn 0.3s ease;
    }

    .modal.hidden {
        display: none;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease;
    }

    @@keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e5e5;
        background: #f9f9f9;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.3rem;
        color: #333;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
        transition: color 0.3s ease;
    }

    .modal-close:hover {
        color: #333;
    }

    .modal-body {
        padding: 30px;
    }

    .form-group {
        margin-bottom: 25px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }

    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="date"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 0.95rem;
        box-sizing: border-box;
    }

    .form-group input[type="checkbox"] {
        margin-right: 8px;
        width: auto;
        cursor: pointer;
    }

    .help-text {
        display: block;
        font-size: 0.8rem;
        color: #999;
        margin-top: 4px;
    }

    .input-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .input-group input {
        flex: 1;
    }

    .sensor-selection {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .btn-small {
        padding: 6px 12px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.3s ease;
    }

    .btn-small:hover {
        background: #e5e5e5;
    }

    .sensor-types-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 10px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        cursor: pointer;
    }

    .checkbox-label input {
        margin-right: 8px;
        width: auto;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 25px;
    }

    .btn-primary, .btn-secondary {
        flex: 1;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5568d3;
    }

    .btn-secondary {
        background: #e5e5e5;
        color: #333;
    }

    .btn-secondary:hover {
        background: #d5d5d5;
    }

    .files-list {
        margin: 20px 0;
        padding: 15px;
        background: #fafafa;
        border-radius: 4px;
        min-height: 100px;
        border: 1px solid #e5e5e5;
        max-height: 200px;
        overflow-y: auto;
    }

    .files-list.empty {
        color: #999;
        text-align: center;
        padding: 30px 15px;
    }

    .file-item {
        padding: 10px;
        background: white;
        border-radius: 3px;
        margin-bottom: 8px;
        font-size: 0.9rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid #e5e5e5;
    }

    /* ç¡¬ä»¶å®¹å™¨æ ·å¼ */
    .hardware-section {
        margin-bottom: 30px;
    }

    .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 20px;
        color: #333;
        padding-bottom: 10px;
        border-bottom: 3px solid #667eea;
    }

    .title-icon {
        font-size: 1.6rem;
    }

    .hardware-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }

    .hardware-card:hover {
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
    }

    .hardware-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .hardware-type {
        font-size: 0.75rem;
        background: #f0f0f0;
        color: #666;
        padding: 3px 8px;
        border-radius: 3px;
        font-weight: 500;
    }

    .sensor-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .sensor-item {
        background: #f9f9f9;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #e5e5e5;
    }

    .sensor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .sensor-name {
        font-size: 0.9rem;
        font-weight: 500;
        color: #666;
    }

    .sensor-value {
        font-size: 1.3rem;
        font-weight: 700;
        color: #333;
        margin: 8px 0;
    }

    .sensor-unit {
        font-size: 0.85rem;
        color: #999;
        margin-left: 4px;
    }

    .sensor-minmax {
        display: flex;
        gap: 10px;
        font-size: 0.8rem;
        color: #999;
        padding-top: 8px;
        border-top: 1px solid #e5e5e5;
    }

    .sensor-status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-top: 0;
    }

    .status-normal {
        background-color: #d4edda;
        color: #155724;
    }

    .status-warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-critical {
        background-color: #f8d7da;
        color: #721c24;
    }

    .sub-hardware-list {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px solid #e5e5e5;
    }

    .sub-hardware-card {
        background: #f9f9f9;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 10px;
        border-left: 3px solid #764ba2;
    }

    .sub-hardware-name {
        font-weight: 600;
        color: #666;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }

    .no-data {
        text-align: center;
        color: #999;
        padding: 20px;
        font-style: italic;
    }

    /* å“åº”å¼è®¾è®¡ */
    @@media (max-width: 1024px) {
        .sensor-list {
            grid-template-columns: 1fr;
        }
    }

    @@media (max-width: 768px) {
        .hardware-header {
            padding: 20px;
        }

        .hardware-header h1 {
            font-size: 1.8rem;
        }

        .header-content {
            flex-direction: column;
            align-items: flex-start;
        }

        .update-info {
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }

        .refresh-btn, .btn-config {
            width: 100%;
            text-align: center;
        }

        .modal-content {
            width: 95%;
            border-radius: 8px;
        }

        .sensor-types-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

@section Scripts {
    <script>
        function updateLastUpdateTime() {
            const time = new Date();
            const formatter = new Intl.DateTimeFormat('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('lastUpdateTime').innerText = formatter.format(time);
        }

        function manualRefresh() {
            refreshHardwareData();
        }

        function refreshHardwareData() {
            fetch('/HardwareMonitor/GetHardwareContent')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('hardwareContent').innerHTML = html;
                    updateLastUpdateTime();
                })
                .catch(error => {
                    console.error('åˆ·æ–°å‡ºé”™:', error);
                });
        }

        // é…ç½®å¼¹æ¡†å‡½æ•°
        function openConfigModal() {
            document.getElementById('configModal').classList.remove('hidden');
            loadRecordingConfig();
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.add('hidden');
        }

        // ä¸‹è½½å¼¹æ¡†å‡½æ•°
        function openDownloadModal() {
            document.getElementById('downloadModal').classList.remove('hidden');
            initDefaultDownloadDates();
        }

        function closeDownloadModal() {
            document.getElementById('downloadModal').classList.add('hidden');
        }

        function initDefaultDownloadDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            loadCsvFiles();
        }

        function loadRecordingConfig() {
            fetch('/HardwareMonitor/GetRecordingConfig')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('enableTimedRecording').checked = data.enableTimedRecording;
                        document.getElementById('recordingInterval').value = data.recordingIntervalSeconds;
                        document.getElementById('csvPath').value = data.csvStoragePath;

                        // æ˜¾ç¤º/éšè—é—´éš”è¾“å…¥æ¡†
                        document.getElementById('intervalGroup').style.display =
                            data.enableTimedRecording ? 'block' : 'none';

                        // è®¾ç½®é€‰ä¸­çš„ä¼ æ„Ÿå™¨ç±»å‹
                        const checkboxes = document.querySelectorAll('input[name="sensorTypes"]');
                        checkboxes.forEach(cb => {
                            cb.checked = data.recordedSensorTypes.length === 0 ||
                                data.recordedSensorTypes.includes(cb.value);
                        });
                    }
                })
                .catch(error => console.error('åŠ è½½é…ç½®å‡ºé”™:', error));
        }

        function saveRecordingConfig() {
            const enableTimedRecording = document.getElementById('enableTimedRecording').checked;
            const recordingIntervalSeconds = parseInt(document.getElementById('recordingInterval').value) || 10;
            const csvStoragePath = document.getElementById('csvPath').value.trim();

            const recordedSensorTypes = [];
            document.querySelectorAll('input[name="sensorTypes"]:checked').forEach(cb => {
                recordedSensorTypes.push(cb.value);
            });

            const config = {
                enableTimedRecording,
                recordingIntervalSeconds: Math.max(recordingIntervalSeconds, 2),
                csvStoragePath: csvStoragePath || 'HardwareData',
                recordedSensorTypes
            };

            fetch('/HardwareMonitor/SaveRecordingConfig', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('é…ç½®ä¿å­˜æˆåŠŸ');
                        closeConfigModal();
                    } else {
                        alert('ä¿å­˜é…ç½®å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('ä¿å­˜é…ç½®å‡ºé”™:', error);
                    alert('ä¿å­˜é…ç½®å‡ºé”™');
                });
        }

        function selectAllSensors() {
            document.querySelectorAll('input[name="sensorTypes"]').forEach(cb => {
                cb.checked = true;
            });
        }

        function clearAllSensors() {
            document.querySelectorAll('input[name="sensorTypes"]').forEach(cb => {
                cb.checked = false;
            });
        }

        function loadCsvFiles() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
                return;
            }

            const params = new URLSearchParams();
            params.append('startDate', startDate);
            params.append('endDate', endDate);

            fetch(`/HardwareMonitor/GetCsvFiles?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    const filesList = document.getElementById('filesList');
                    if (data.success && data.files.length > 0) {
                        filesList.classList.remove('empty');
                        filesList.innerHTML = data.files.map(f =>
                            `<div class="file-item">
                                <span>${f.name}</span>
                                <span>${formatFileSize(f.size)}</span>
                            </div>`
                        ).join('');
                    } else {
                        filesList.classList.add('empty');
                        filesList.innerHTML = '<div>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶</div>';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å‡ºé”™:', error);
                    document.getElementById('filesList').innerHTML = '<div class="empty">åŠ è½½å‡ºé”™</div>';
                });
        }

        function downloadCsvZip() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                return;
            }

            const params = new URLSearchParams();
            params.append('startDate', startDate);
            params.append('endDate', endDate);

            window.location.href = `/HardwareMonitor/DownloadCsvZip?${params.toString()}`;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // ç›‘å¬å¯ç”¨å®šæ—¶è®°å½•çš„å¤é€‰æ¡†
        document.getElementById('enableTimedRecording')?.addEventListener('change', function () {
            document.getElementById('intervalGroup').style.display = this.checked ? 'block' : 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        document.getElementById('configModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closeConfigModal();
            }
        });

        document.getElementById('downloadModal')?.addEventListener('click', function (e) {
            if (e.target === this) {
                closeDownloadModal();
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°æ—¶é—´
        updateLastUpdateTime();

        // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ—¶é—´
        setInterval(updateLastUpdateTime, 1000);

        // æ¯5ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ç¡¬ä»¶æ•°æ®
        setInterval(refreshHardwareData, 5000);
    </script>
}

@functions {
    private string GetSensorTypeDisplay(string sensorType)
    {
        return sensorType switch
        {
            "Temperature" => "æ¸©åº¦",
            "Voltage" => "ç”µå‹",
            "Fan" => "é£æ‰‡",
            "Power" => "åŠŸç‡",
            "Load" => "è´Ÿè½½",
            "Clock" => "æ—¶é’Ÿ",
            "Data" => "æ•°æ®",
            "Flow" => "æµé‡",
            "Level" => "æ¶²ä½",
            "Frequency" => "é¢‘ç‡",
            "Current" => "ç”µæµ",
            "Energy" => "èƒ½é‡",
            "SmallData" => "å°æ•°æ®",
            "Throughput" => "ååé‡",
            "TimeSpan" => "æ—¶é•¿",
            "Noise" => "å™ªå£°",
            "Humidity" => "æ¹¿åº¦",
            _ => sensorType
        };
    }
}
