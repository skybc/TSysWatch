# CPU 核心数管理器测试用例

## 1. 权限测试

### 测试用例 1.1：管理员权限检查
**描述：** 验证程序需要管理员权限才能正常工作
**前置条件：** 程序以普通用户权限运行
**预期结果：** 显示错误提示"程序必须以管理员权限运行！"

### 测试用例 1.2：调试权限启用
**描述：** 验证 SeDebugPrivilege 权限启用
**前置条件：** 程序以管理员权限运行
**预期结果：** 日志显示"调试权限启用成功"

## 2. 配置管理测试

### 测试用例 2.1：配置文件读取
**描述：** 验证配置文件正确读取
**测试数据：** 标准 CpuCoreManager.ini 文件
**预期结果：** 配置参数正确加载

### 测试用例 2.2：配置文件保存
**描述：** 验证配置修改后正确保存
**测试步骤：** 修改默认核心数并保存
**预期结果：** ini 文件内容正确更新

### 测试用例 2.3：配置参数验证
**描述：** 验证配置参数边界值处理
**测试数据：** 
- DefaultCoreCount = 0（应修正为1）
- DefaultCoreCount = 999（应修正为系统核心数）
- ScanIntervalSeconds = 0（应修正为1）

## 3. 进程核心数设置测试

### 测试用例 3.1：有效进程设置
**描述：** 为正常进程设置核心数
**测试步骤：** 选择一个非关键进程，设置为2个核心
**预期结果：** 进程亲和性掩码正确设置为0x03

### 测试用例 3.2：系统关键进程跳过
**描述：** 验证系统关键进程不被修改
**测试数据：** System、csrss、explorer 等进程
**预期结果：** 这些进程被跳过，不进行亲和性设置

### 测试用例 3.3：无效进程ID处理
**描述：** 处理不存在的进程ID
**测试数据：** 不存在的PID（如999999）
**预期结果：** 返回失败，记录相应错误日志

### 测试用例 3.4：权限不足的进程
**描述：** 处理无权限访问的进程
**预期结果：** 记录"Access Denied"状态

## 4. 亲和性掩码计算测试

### 测试用例 4.1：单核心掩码
**描述：** 计算1个核心的亲和性掩码
**预期结果：** 0x01

### 测试用例 4.2：双核心掩码
**描述：** 计算2个核心的亲和性掩码
**预期结果：** 0x03

### 测试用例 4.3：四核心掩码
**描述：** 计算4个核心的亲和性掩码
**预期结果：** 0x0F

### 测试用例 4.4：超出系统核心数
**描述：** 核心数超出系统最大值
**测试数据：** 在8核系统上设置16核
**预期结果：** 自动修正为系统最大核心数

## 5. 扫描服务测试

### 测试用例 5.1：定时扫描
**描述：** 验证后台定时扫描功能
**测试步骤：** 启动服务，等待扫描间隔
**预期结果：** 按配置间隔执行扫描

### 测试用例 5.2：手动扫描触发
**描述：** 通过API手动触发扫描
**测试步骤：** 调用 POST /api/cpucore/scan
**预期结果：** 立即执行一次扫描

### 测试用例 5.3：扫描异常处理
**描述：** 扫描过程中遇到异常的处理
**预期结果：** 记录错误日志，继续处理其他进程

## 6. Web界面测试

### 测试用例 6.1：进程列表显示
**描述：** 验证进程列表正确显示
**预期结果：** 显示PID、进程名、配置核心数、当前核心数等信息

### 测试用例 6.2：配置修改界面
**描述：** 通过Web界面修改配置
**测试步骤：** 修改默认核心数、添加进程映射
**预期结果：** 配置正确保存并生效

### 测试用例 6.3：日志查看
**描述：** 查看操作日志
**预期结果：** 显示最近的操作记录，包括时间、PID、结果等

## 7. API测试

### 测试用例 7.1：REST API响应格式
**描述：** 验证所有API返回标准JSON格式
**预期结果：** 包含success字段和相应的data或message字段

### 测试用例 7.2：API错误处理
**描述：** 无效请求的错误处理
**测试数据：** 无效的JSON、错误的参数
**预期结果：** 返回错误信息

## 8. 边界条件测试

### 测试用例 8.1：系统资源耗尽
**描述：** 在系统资源紧张时的行为
**预期结果：** 优雅处理，记录相应日志

### 测试用例 8.2：大量进程处理
**描述：** 系统有大量进程时的性能
**预期结果：** 扫描在合理时间内完成

### 测试用例 8.3：进程频繁启停
**描述：** 进程在扫描过程中启动或退出
**预期结果：** 正确处理异常，不影响其他进程

## 9. 日志测试

### 测试用例 9.1：日志记录完整性
**描述：** 验证所有操作都有相应日志
**预期结果：** 成功和失败的操作都有记录

### 测试用例 9.2：日志轮转
**描述：** 验证日志数量控制
**预期结果：** 超过1000条时自动清理最旧的100条

## 10. 性能测试

### 测试用例 10.1：扫描性能
**描述：** 测量单次扫描耗时
**预期结果：** 在100个进程的系统上，扫描时间<5秒

### 测试用例 10.2：内存使用
**描述：** 监控服务内存使用情况
**预期结果：** 内存使用稳定，无内存泄漏

## 自动化测试脚本

```powershell
# 自动化测试脚本
$baseUrl = "http://localhost:5000/api/cpucore"

Write-Host "开始 CPU 核心管理器测试..."

# 测试1：获取系统信息
Write-Host "测试1：获取系统信息"
try {
    $systemInfo = Invoke-RestMethod -Uri "$baseUrl/system" -Method GET
    if ($systemInfo.success) {
        Write-Host "✓ 系统信息获取成功" -ForegroundColor Green
        Write-Host "  处理器核心数: $($systemInfo.data.processorCount)"
        Write-Host "  管理员权限: $($systemInfo.data.isAdministrator)"
    } else {
        Write-Host "✗ 系统信息获取失败" -ForegroundColor Red
    }
} catch {
    Write-Host "✗ 系统信息API调用异常: $($_.Exception.Message)" -ForegroundColor Red
}

# 测试2：获取进程列表
Write-Host "`n测试2：获取进程列表"
try {
    $processes = Invoke-RestMethod -Uri "$baseUrl/processes" -Method GET
    if ($processes.success) {
        Write-Host "✓ 进程列表获取成功，共 $($processes.data.Count) 个进程" -ForegroundColor Green
    } else {
        Write-Host "✗ 进程列表获取失败" -ForegroundColor Red
    }
} catch {
    Write-Host "✗ 进程列表API调用异常: $($_.Exception.Message)" -ForegroundColor Red
}

# 测试3：手动触发扫描
Write-Host "`n测试3：手动触发扫描"
try {
    $scanResult = Invoke-RestMethod -Uri "$baseUrl/scan" -Method POST
    if ($scanResult.success) {
        Write-Host "✓ 手动扫描触发成功" -ForegroundColor Green
    } else {
        Write-Host "✗ 手动扫描触发失败" -ForegroundColor Red
    }
} catch {
    Write-Host "✗ 扫描API调用异常: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "`n测试完成！"
```