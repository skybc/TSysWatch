# 端口检测与自适应启动（PortDetection）

## 概述

端口检测与自适应启动功能确保应用程序能够在端口被占用的情况下自动选择可用端口，避免重复启动失败和服务中断。

## 功能特性

- **端口可用性检测**: 自动检查配置端口（8002）是否被占用
- **自动端口切换**: 端口被占用时自动在 8003-8200 范围内搜索可用端口
- **启动日志记录**: 将端口选择信息和原因输出到日志文件
- **无缝切换**: 用户无需手动干预，程序自动处理

## 工作流程

1. 应用启动时，先检查默认端口 8002 是否被占用
2. 如果 8002 可用，直接使用该端口启动
3. 如果 8002 被占用，依次检查 8003-8200 范围内的端口
4. 找到第一个可用端口后使用该端口启动
5. 将端口选择的详细信息记录到日志文件

## 技术架构

### 核心组件

| 组件 | 位置 | 职责 |
|-----|------|-----|
| PortDetectionService | Services/PortDetectionService.cs | 端口检测和选择逻辑 |
| Program.cs | Program.cs | 集成端口检测服务 |

### 检测范围

- **默认端口**: 8002
- **替代范围**: 8003-8200（共 198 个备选端口）
- **检测方法**: 使用 IPGlobalProperties API 检查 TCP 监听器

## 日志记录

### 位置
`Logs/port_detection.log`

### 日志格式
```
[时间戳] 端口状态说明 | 最终使用端口: xxxx
```

### 示例
```
[2026-01-30 08:07:27.580] 端口 8002 可用 | 最终使用端口: 8002
[2026-01-30 08:09:28.162] 端口 8002 已被占用，自动选择端口 8003 | 最终使用端口: 8003
```

## 集成点

### 启动流程
在 `Program.cs` 的 `Main` 方法中，应用启动前调用：
```csharp
var portDetectionService = new PortDetectionService();
int availablePort = portDetectionService.GetAvailablePort();
builder.WebHost.UseUrls($"http://*:{availablePort}");
```

## 相关文件

| 文件 | 用途 |
|-----|-----|
| Services/PortDetectionService.cs | 端口检测服务实现 |
| Program.cs | 应用程序入口和服务集成 |
| Logs/port_detection.log | 端口检测日志 |
| appsettings.json | 应用配置（端口配置已移至代码） |

## 错误处理

- 检查端口时发生异常，作为端口被占用处理（保险起见）
- 记录端口选择失败如果任何异常
- 记录日志失败不影响应用启动

## 性能考量

- 端口检测使用系统 API，检查速度极快（< 100ms）
- 对应用启动时间影响微乎其微
- 每次启动都执行检测，确保每次都能获取最新的端口状态

## 使用场景

| 场景 | 说明 |
|-----|-----|
| 开发测试 | 多个实例同时运行，避免端口冲突 |
| 服务重启 | 前一个实例未完全释放端口时仍能启动 |
| Windows 服务 | 作为 Windows 服务运行时自动处理端口占用 |
| 容器化部署 | 多容器环境下避免端口冲突 |

## 后续改进

- [ ] 支持配置文件指定替代端口范围
- [ ] 支持多个优先端口配置
- [ ] 集成健康检查端点
- [ ] 出现端口切换时发送系统通知

## 测试验证

已验证功能：
- ✓ 默认端口可用时正常使用 8002
- ✓ 端口 8002 被占用时自动切换到 8003
- ✓ 日志文件正确记录所有端口选择决策
- ✓ 应用正常启动和运行
