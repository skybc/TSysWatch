# Web è‡ªæ›´æ–°ç³»ç»Ÿ - å®Œæ•´å®ç°æ€»ç»“

## ğŸ“¦ äº¤ä»˜ç‰©æ¸…å•

### Web ç¨‹åºï¼ˆTSysWatch é¡¹ç›®ï¼‰

#### ç±»ä¸æ¥å£

| æ–‡ä»¶ | è¯´æ˜ | è¡Œæ•° |
|------|------|------|
| **Controllers/SelfUpdateController.cs** | REST API ç«¯ç‚¹ | ~200+ |
| **Services/SelfUpdateService.cs** | ä¸šåŠ¡é€»è¾‘å®ç° | ~400+ |
| **Services/SelfUpdateConfigManager.cs** | é…ç½®ç®¡ç† | ~150+ |
| **Models/SelfUpdateConfig.cs** | é…ç½®æ¨¡å‹ | ~50+ |
| **Models/VersionInfo.cs** | ç‰ˆæœ¬ä¿¡æ¯ | ~30+ |
| **Models/SelfUpdateResponse.cs** | API å“åº” | ~40+ |

#### é…ç½®æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `ini_config/SelfUpdate.json` | é…ç½®æ–‡ä»¶æ¨¡æ¿ |
| `Program.cs` | å·²æ³¨å†ŒæœåŠ¡ |

#### æ–‡æ¡£

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `doc/modules/31-self-update.md` | å®Œæ•´åŠŸèƒ½æ–‡æ¡£ |
| `doc/modules/31-self-update-quickstart.md` | å¿«é€Ÿå¼€å§‹æŒ‡å— |
| `doc/modules/31-self-update-architecture.md` | æ¶æ„è®¾è®¡æ–‡æ¡£ |
| `doc/readme.md` | å¯¼èˆªæ–‡æ¡£ï¼ˆå·²æ›´æ–°ï¼‰ |

#### æµ‹è¯•è„šæœ¬

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `doc/test-update.bat` | Windows æ‰¹å¤„ç†è„šæœ¬ |
| `doc/test-update.ps1` | PowerShell è„šæœ¬ |
| `doc/test-update.py` | Python è„šæœ¬ |

---

### Updater.exe é¡¹ç›®ï¼ˆç‹¬ç«‹ï¼‰

#### é¡¹ç›®æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `Updater.csproj` | é¡¹ç›®é…ç½® |
| `Program.cs` | å…¥å£ç‚¹ + ç®¡ç†å‘˜æ£€æŸ¥ |

#### ç±»ä¸æ¥å£

| æ–‡ä»¶ | è¯´æ˜ | è¡Œæ•° |
|------|------|------|
| **UpdaterArguments.cs** | å‘½ä»¤è¡Œå‚æ•°è§£æ | ~150+ |
| **HostManager.cs** | å®¿ä¸»ç®¡ç†ï¼ˆIIS/Service/Kestrelï¼‰ | ~400+ |
| **UpdateExecutor.cs** | æ›´æ–°æ‰§è¡Œé€»è¾‘ | ~500+ |

---

## ğŸ¯ API ç«¯ç‚¹æ€»è§ˆ

| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| POST | `/api/self-update/upload` | ä¸Šä¼  update.zip |
| POST | `/api/self-update/apply` | è§¦å‘æ›´æ–° |
| GET | `/api/self-update/package-info` | æŸ¥è¯¢åŒ…ä¿¡æ¯ |
| POST | `/api/self-update/cleanup` | æ¸…ç†è¿‡æœŸåŒ… |
| GET | `/api/self-update/health` | å¥åº·æ£€æŸ¥ |

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç”¨æˆ·æ“ä½œ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web ç¨‹åº (ASP.NET Core)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ¥æ”¶ä¸Šä¼                           â”‚
â”‚ â€¢ éªŒè¯æ–‡ä»¶                          â”‚
â”‚ â€¢ å¯åŠ¨ Updater.exe                  â”‚
â”‚ â€¢ è¿”å›çŠ¶æ€                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ (Process.Start)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Updater.exe (ç‹¬ç«‹è¿›ç¨‹)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ åœæ­¢ Web å®¿ä¸»                     â”‚
â”‚ â€¢ å¤‡ä»½å½“å‰ç‰ˆæœ¬                      â”‚
â”‚ â€¢ è§£å‹æ–°ç‰ˆæœ¬                        â”‚
â”‚ â€¢ è¦†ç›–æ–‡ä»¶                          â”‚
â”‚ â€¢ éªŒè¯æ›´æ–°                          â”‚
â”‚ â€¢ å¯åŠ¨ Web å®¿ä¸»                     â”‚
â”‚ â€¢ å¤±è´¥æ—¶å›æ»š                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web ç¨‹åºæ¢å¤è¿è¡Œ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ å…³é”®å®ç°ç‰¹æ€§

### âœ… Web ç«¯

1. **ä¸Šä¼ æ¥å£**
   - æ”¯æŒ multipart/form-data
   - æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆä»…å…è®¸ .zipï¼‰
   - æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆé»˜è®¤ 500MBï¼‰
   - ç‰ˆæœ¬ä¿¡æ¯è¯»å–

2. **è§¦å‘æ¥å£**
   - å‚æ•°æ„å»ºä¸ä¼ é€’
   - è¿›ç¨‹å¯åŠ¨ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
   - é”™è¯¯å¤„ç†

3. **æŸ¥è¯¢æ¥å£**
   - åŒ…ä¿¡æ¯è·å–
   - ç‰ˆæœ¬ä¿¡æ¯è§£æ
   - è¿‡æœŸåŒ…æ¸…ç†

4. **é…ç½®ç®¡ç†**
   - JSON é…ç½®åŠ è½½
   - å‚æ•°éªŒè¯
   - ç›®å½•è‡ªåŠ¨åˆ›å»º

### âœ… Updater ç«¯

1. **å‘½ä»¤è¡Œè§£æ**
   - çµæ´»çš„å‚æ•°æ ¼å¼
   - å‚æ•°éªŒè¯
   - é»˜è®¤å€¼è®¾ç½®

2. **å®¿ä¸»ç®¡ç†**
   - IIS (appcmd.exe)
   - Windows Service (ServiceController)
   - Kestrel (Kill/Start è¿›ç¨‹)

3. **æ›´æ–°æ‰§è¡Œ**
   - 6 æ­¥æµç¨‹
   - è¿›åº¦è®°å½•
   - è¶…æ—¶æ§åˆ¶

4. **å¤‡ä»½ä¸å›æ»š**
   - è‡ªåŠ¨æ—¶é—´æˆ³å¤‡ä»½
   - å¤±è´¥è‡ªåŠ¨å›æ»š
   - å¤‡ä»½æ¸…ç†

5. **æ—¥å¿—è®°å½•**
   - æ–‡ä»¶æ—¥å¿—è¾“å‡º
   - Serilog é›†æˆ
   - è¯¦ç»†çš„æ“ä½œè®°å½•

## ğŸ”„ å·¥ä½œæµç¨‹

### å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·å‡†å¤‡ update.zip
   â””â”€ ç»“æ„: update/web/[æ–‡ä»¶], update/version.json

2. ä¸Šä¼  update.zip
   â””â”€ POST /api/self-update/upload
   â””â”€ å“åº”: ä¸Šä¼ æˆåŠŸï¼Œç‰ˆæœ¬ä¿¡æ¯

3. è§¦å‘æ›´æ–°
   â””â”€ POST /api/self-update/apply
   â””â”€ Web å¯åŠ¨ Updater.exe
   â””â”€ Web è¿”å›ï¼šæ›´æ–°å·²å¼€å§‹

4. Updater æ‰§è¡Œæ›´æ–°ï¼ˆ6 æ­¥ï¼‰
   â”œâ”€ ã€æ­¥éª¤ 1/6ã€‘åœæ­¢ Web å®¿ä¸»
   â”œâ”€ ã€æ­¥éª¤ 2/6ã€‘å¤‡ä»½ Web ç›®å½•
   â”œâ”€ ã€æ­¥éª¤ 3/6ã€‘è§£å‹æ›´æ–°åŒ…
   â”œâ”€ ã€æ­¥éª¤ 4/6ã€‘è¦†ç›– Web æ–‡ä»¶
   â”œâ”€ ã€æ­¥éª¤ 5/6ã€‘éªŒè¯æ›´æ–°
   â””â”€ ã€æ­¥éª¤ 6/6ã€‘å¯åŠ¨ Web å®¿ä¸»

5. å¤±è´¥æ—¶
   â””â”€ è‡ªåŠ¨å›æ»š
   â””â”€ æ¢å¤å¤‡ä»½
   â””â”€ é‡å¯æ—§ç‰ˆæœ¬

6. Web æ¢å¤æ­£å¸¸
   â””â”€ æ¥å—æ–°è¯·æ±‚
   â””â”€ è¿è¡Œæ–°ç‰ˆæœ¬
```

## ğŸ“Š é…ç½®ç¤ºä¾‹

### Kestrel é…ç½®

```json
{
  "enabled": true,
  "packageDirectory": "C:\\WebUpdater\\packages",
  "backupDirectory": "C:\\WebUpdater\\backup",
  "updaterExePath": "C:\\WebUpdater\\Updater\\Updater.exe",
  "hostingType": "Kestrel",
  "kestrelProcessName": "dotnet",
  "maxPackageSize": 524288000,
  "updateTimeoutMs": 300000
}
```

### IIS é…ç½®

```json
{
  "enabled": true,
  "hostingType": "IIS",
  "iisAppPoolName": "DefaultAppPool",
  "iisSiteName": "Default Web Site"
}
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### 1. Web é¡¹ç›®ç¼–è¯‘

```bash
cd TSysWatch
dotnet build
```

### 2. Updater ç‹¬ç«‹ç¼–è¯‘

```bash
cd Updater
dotnet publish -c Release -r win-x64 --self-contained
```

### 3. é…ç½®éƒ¨ç½²ç›®å½•

```
C:\Program Files\
â”œâ”€ TSysWatch\           # Web ç¨‹åº
â”œâ”€ Updater\             # Updater.exe
â”œâ”€ WebUpdater\
   â”œâ”€ packages\         # ä¸Šä¼ çš„æ›´æ–°åŒ…
   â””â”€ backup\           # å¤‡ä»½æ•°æ®
```

### 4. ä¿®æ”¹é…ç½®æ–‡ä»¶

ç¼–è¾‘ `TSysWatch/ini_config/SelfUpdate.json`ï¼Œé…ç½®ï¼š
- `updaterExePath`ï¼šæŒ‡å‘ Updater.exe
- `hostingType`ï¼šè®¾ç½®å®¿ä¸»ç±»å‹
- å®¿ä¸»ç›¸å…³å‚æ•°ï¼ˆæ ¹æ®ç±»å‹å¡«å……ï¼‰

### 5. æµ‹è¯•

```bash
# ä½¿ç”¨ PowerShell
powershell -File test-update.ps1

# æˆ–ä½¿ç”¨ Python
python test-update.py

# æˆ–ä½¿ç”¨ curl
curl -X POST http://localhost/api/self-update/apply
```

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **è¿›ç¨‹éš”ç¦»**ï¼šWeb å’Œ Updater å®Œå…¨åˆ†ç¦»
2. **æƒé™ç®¡ç†**ï¼šUpdater éœ€è¦ç®¡ç†å‘˜æƒé™
3. **æ–‡ä»¶éªŒè¯**ï¼šZIP æ–‡ä»¶æ ¼å¼éªŒè¯
4. **å¤‡ä»½ä¿æŠ¤**ï¼šæ›´æ–°å‰å¿…é¡»å¤‡ä»½
5. **è‡ªåŠ¨å›æ»š**ï¼šå‡ºé”™è‡ªåŠ¨æ¢å¤
6. **æ—¥å¿—å®¡è®¡**ï¼šå®Œæ•´çš„æ“ä½œè®°å½•

## ğŸ“ æ—¥å¿—ç¤ºä¾‹

```
[2026-01-29 10:30:00.000 +08:00] [INF] ================================
[2026-01-29 10:30:00.000 +08:00] [INF] Updater.exe å¯åŠ¨
[2026-01-29 10:30:00.000 +08:00] [INF] å‘½ä»¤è¡Œå‚æ•°: --package-path ...
[2026-01-29 10:30:00.000 +08:00] [INF] è¿è¡Œä½ç½®: C:\WebUpdater\Updater
[2026-01-29 10:30:00.000 +08:00] [INF] ================================
[2026-01-29 10:30:00.000 +08:00] [INF] Web æ ¹ç›®å½•: C:\Program Files\TSysWatch
[2026-01-29 10:30:00.000 +08:00] [INF] ã€æ­¥éª¤ 1/6ã€‘åœæ­¢ Web å®¿ä¸»...
[2026-01-29 10:30:02.000 +08:00] [INF] âœ“ Web å®¿ä¸»å·²åœæ­¢
[2026-01-29 10:30:02.000 +08:00] [INF] ã€æ­¥éª¤ 2/6ã€‘å¤‡ä»½å½“å‰ Web ç›®å½•...
[2026-01-29 10:30:05.000 +08:00] [INF] âœ“ Web ç›®å½•å¤‡ä»½æˆåŠŸ: backup/web_20260129_103002
[2026-01-29 10:30:05.000 +08:00] [INF] ã€æ­¥éª¤ 3/6ã€‘è§£å‹æ›´æ–°åŒ…...
[2026-01-29 10:30:08.000 +08:00] [INF] âœ“ æ›´æ–°åŒ…å·²è§£å‹
[2026-01-29 10:30:08.000 +08:00] [INF] ã€æ­¥éª¤ 4/6ã€‘è¦†ç›– Web ç¨‹åºæ–‡ä»¶...
[2026-01-29 10:30:10.000 +08:00] [INF] âœ“ å…±å¤åˆ¶ 1256 ä¸ªæ–‡ä»¶
[2026-01-29 10:30:10.000 +08:00] [INF] ã€æ­¥éª¤ 5/6ã€‘éªŒè¯æ›´æ–°...
[2026-01-29 10:30:10.000 +08:00] [INF] ã€æ­¥éª¤ 6/6ã€‘å¯åŠ¨ Web å®¿ä¸»...
[2026-01-29 10:30:12.000 +08:00] [INF] âœ“ Web å®¿ä¸»å·²å¯åŠ¨
[2026-01-29 10:30:12.000 +08:00] [INF] === Web ç¨‹åºæ›´æ–°å®Œæˆ ===
```

## ğŸ› æ•…éšœæ’æŸ¥

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| æƒé™ä¸è¶³ | ç¡®ä¿ Updater ä»¥ç®¡ç†å‘˜è¿è¡Œ |
| æ›´æ–°è¶…æ—¶ | å¢åŠ  `updateTimeoutMs` æˆ–æ£€æŸ¥æ—¥å¿— |
| Web æ— æ³•å¯åŠ¨ | éªŒè¯ `updaterExePath` æˆ–æ£€æŸ¥å¤‡ä»½ |
| æ–‡ä»¶è¢«å ç”¨ | Updater ä¼šè‡ªåŠ¨é‡è¯•ï¼Œæ£€æŸ¥è¿›ç¨‹çŠ¶æ€ |

## ğŸ“š æ–‡æ¡£å¯¼èˆª

| æ–‡æ¡£ | ç”¨é€” |
|------|------|
| `31-self-update.md` | å®Œæ•´åŠŸèƒ½æ–‡æ¡£ |
| `31-self-update-quickstart.md` | å¿«é€Ÿå¼€å§‹æŒ‡å— |
| `31-self-update-architecture.md` | æ¶æ„è®¾è®¡ç»†èŠ‚ |
| `test-update.bat` / `.ps1` / `.py` | æµ‹è¯•è„šæœ¬ |

## âœ¨ å®Œæˆæ¸…å•

- [x] Web Controllerï¼ˆ5 ä¸ª API ç«¯ç‚¹ï¼‰
- [x] Web Serviceï¼ˆä¸Šä¼ ã€è§¦å‘ã€æŸ¥è¯¢ã€æ¸…ç†ï¼‰
- [x] é…ç½®ç®¡ç†ï¼ˆJSON é…ç½®åŠ è½½ï¼‰
- [x] Updater ç¨‹åºï¼ˆå®Œæ•´çš„æ›´æ–°é€»è¾‘ï¼‰
- [x] å®¿ä¸»ç®¡ç†ï¼ˆIISã€Serviceã€Kestrelï¼‰
- [x] å¤‡ä»½å›æ»šï¼ˆè‡ªåŠ¨å¤‡ä»½ã€å¤±è´¥å›æ»šï¼‰
- [x] æ—¥å¿—è®°å½•ï¼ˆå®Œæ•´çš„æ“ä½œæ—¥å¿—ï¼‰
- [x] å‘½ä»¤è¡Œå‚æ•°ï¼ˆçµæ´»çš„å‚æ•°ä¼ é€’ï¼‰
- [x] è¶…æ—¶æ§åˆ¶ï¼ˆé˜²æ­¢æ›´æ–°å¡æ­»ï¼‰
- [x] å®Œæ•´æ–‡æ¡£ï¼ˆ3 ä¸ªè¯¦ç»†æ–‡æ¡£ï¼‰
- [x] æµ‹è¯•è„šæœ¬ï¼ˆ3 ç§è¯­è¨€ï¼‰
- [x] ç”Ÿäº§å°±ç»ªï¼ˆä¸­æ–‡æ³¨é‡Šã€å®Œæ•´é”™è¯¯å¤„ç†ï¼‰

## ğŸ“ ä»£ç è´¨é‡

- âœ… éµå¾ª SOLID åŸåˆ™
- âœ… ä½¿ç”¨ XML æ³¨é‡Šï¼ˆä¸­æ–‡ï¼‰
- âœ… å¯ç”¨å¯ç©ºå¼•ç”¨ç±»å‹
- âœ… å¼‚æ­¥/ç­‰å¾…æ¨¡å¼
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… ç”Ÿäº§çº§æ—¥å¿—è®°å½•
- âœ… ä¼ä¸šçº§æ¶æ„è®¾è®¡

## ğŸ“ ä½¿ç”¨æ”¯æŒ

æœ¬å®ç°åŒ…å«å®Œæ•´çš„ï¼š
- API æ–‡æ¡£ï¼ˆOpenAPI é£æ ¼æ³¨é‡Šï¼‰
- é…ç½®æŒ‡å—ï¼ˆå¤šå®¿ä¸»ç¤ºä¾‹ï¼‰
- æ•…éšœæ’æŸ¥æŒ‡å—ï¼ˆå¸¸è§é—®é¢˜è§£å†³ï¼‰
- æµ‹è¯•è„šæœ¬ï¼ˆ3 ç§è¯­è¨€ï¼‰
- æ¶æ„æ–‡æ¡£ï¼ˆè¯¦ç»†çš„è®¾è®¡è¯´æ˜ï¼‰

---

## å¿«é€Ÿå¼€å§‹

1. **ç¼–è¯‘ Web**ï¼š`dotnet build`
2. **ç¼–è¯‘ Updater**ï¼š`cd Updater && dotnet publish -c Release -r win-x64`
3. **é…ç½®**ï¼šç¼–è¾‘ `ini_config/SelfUpdate.json`
4. **éƒ¨ç½²**ï¼šæŠŠ Updater æ”¾åˆ°é…ç½®çš„ç›®å½•
5. **æµ‹è¯•**ï¼šè¿è¡Œ `test-update.ps1` æˆ– `test-update.py`

---

**æœ¬å®ç°æ˜¯ç”Ÿäº§å°±ç»ªçš„ã€å®‰å…¨çš„ã€å®Œæ•´çš„ Web è‡ªæ›´æ–°ç³»ç»Ÿã€‚**
