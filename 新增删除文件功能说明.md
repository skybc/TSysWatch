# 自动删除文件功能增强说明

## 新增功能概述

在原有的自动删除文件功能基础上，新增了以下两个重要配置项：

### 1. 开始删除文件时间（天）- `StartDeleteFileDays`
- **功能**: 限制只删除文件的最后修改时间（或创建时间）距离当前时间超过N天的数据
- **配置**: `StartDeleteFileDays=30` （表示只删除超过30天的文件）
- **特殊值**: `0` 表示不限制时间，所有文件都可以被删除

### 2. 删除条件逻辑关系 - `LogicMode`
- **功能**: 配置容量阈值和时间阈值之间的逻辑关系
- **支持模式**:
  - `OR`：满足容量或时间条件之一即可删除
  - `AND`：必须同时满足容量和时间条件才删除

## 配置文件示例

```ini
# 自动删除文件配置
# DeleteDirectories=目录1,目录2,目录3
# StartDeleteSizeGB=开始删除时的磁盘剩余空间(GB)
# StopDeleteSizeGB=停止删除时的磁盘剩余空间(GB)
# StartDeleteFileDays=开始删除文件时间(天) - 只删除超过N天的文件，0表示不限制时间
# LogicMode=删除条件逻辑关系 - AND(且)/OR(或)

# C盘配置 - 使用OR逻辑：空间不足或文件超过30天就删除
[C:]
DeleteDirectories=C:\temp,C:\Windows\temp,C:\Users\Public\temp
StartDeleteSizeGB=5.0
StopDeleteSizeGB=10.0
StartDeleteFileDays=30
LogicMode=OR

# D盘配置 - 使用AND逻辑：必须同时满足空间不足且文件超过7天才删除
[D:]
DeleteDirectories=D:\temp,D:\logs,D:\cache
StartDeleteSizeGB=10.0
StopDeleteSizeGB=20.0
StartDeleteFileDays=7
LogicMode=AND

# E盘配置 - 仅基于时间删除：只删除超过90天的文件，不考虑磁盘空间
[E:]
DeleteDirectories=E:\temp,E:\backup\old
StartDeleteSizeGB=0.0
StopDeleteSizeGB=0.0
StartDeleteFileDays=90
LogicMode=OR
```

## 使用场景说明

### 场景1：紧急空间清理（OR模式）
- **配置**: `LogicMode=OR, StartDeleteSizeGB=5.0, StartDeleteFileDays=30`
- **效果**: 当磁盘剩余空间少于5GB时，立即删除文件；或者删除超过30天的旧文件
- **适用**: 系统盘、缓存目录等需要快速释放空间的场景

### 场景2：安全清理（AND模式）
- **配置**: `LogicMode=AND, StartDeleteSizeGB=10.0, StartDeleteFileDays=7`
- **效果**: 只有在磁盘空间不足且文件超过7天时才删除
- **适用**: 重要数据目录，避免误删除新文件

### 场景3：定期清理（OR模式 + 时间优先）
- **配置**: `LogicMode=OR, StartDeleteSizeGB=0.0, StartDeleteFileDays=90`
- **效果**: 只删除超过90天的文件，不考虑磁盘空间
- **适用**: 日志文件、临时备份等定期清理场景

## 核心代码实现

### 1. 配置模型扩展
```csharp
public class DiskCleanupConfig
{
    // 原有配置项...
    
    /// <summary>
    /// 开始删除文件时间（天）- 只删除超过N天的文件
    /// </summary>
    public int StartDeleteFileDays { get; set; } = 0;
    
    /// <summary>
    /// 删除条件逻辑关系：AND（且）或 OR（或）
    /// </summary>
    public DeleteLogicMode LogicMode { get; set; } = DeleteLogicMode.OR;
}

public enum DeleteLogicMode
{
    OR,   // 或 - 满足容量或时间条件之一即可删除
    AND   // 且 - 必须同时满足容量和时间条件才删除
}
```

### 2. 文件时间检查
```csharp
public static bool IsFileOlderThanDays(string filePath, int days)
{
    if (days <= 0) return true; // 0天表示不限制时间

    var fileInfo = new FileInfo(filePath);
    // 取文件的创建时间和最后修改时间中较新的一个
    var fileTime = fileInfo.CreationTime > fileInfo.LastWriteTime 
        ? fileInfo.CreationTime 
        : fileInfo.LastWriteTime;

    var threshold = DateTime.Now.AddDays(-days);
    return fileTime < threshold;
}
```

### 3. 删除条件判断
```csharp
public static bool ShouldDeleteFile(DiskCleanupConfig config, double currentFreeSpaceGB, string filePath)
{
    // 检查容量条件
    bool capacityCondition = currentFreeSpaceGB < config.StartDeleteSizeGB;
    
    // 检查时间条件
    bool timeCondition = IsFileOlderThanDays(filePath, config.StartDeleteFileDays);

    // 根据逻辑关系返回结果
    switch (config.LogicMode)
    {
        case DeleteLogicMode.AND:
            return capacityCondition && timeCondition;
        case DeleteLogicMode.OR:
            return capacityCondition || timeCondition;
    }
}
```

## Web管理界面

新增了Web管理界面，可以通过 `/AutoDelete/Index` 访问：

- **配置查看**: 显示当前所有磁盘的删除配置
- **磁盘状态**: 实时显示磁盘使用情况
- **条件测试**: 测试指定文件是否会被删除
- **API接口**: 提供 REST API 用于集成

## 兼容性说明

- **向后兼容**: 现有配置文件无需修改，新配置项有默认值
- **默认行为**: 
  - `StartDeleteFileDays` 默认为 0（不限制时间）
  - `LogicMode` 默认为 OR（原有行为）
- **配置升级**: 系统会自动为现有配置添加默认的新配置项

## 测试建议

1. **配置测试**: 先使用较大的时间阈值（如90天）进行测试
2. **逻辑验证**: 使用Web管理界面的测试工具验证删除条件
3. **分阶段部署**: 先在测试环境验证，再逐步应用到生产环境
4. **监控日志**: 密切关注删除日志，确保删除行为符合预期

通过这些新功能，自动删除文件系统更加灵活和安全，可以满足不同场景的需求。
