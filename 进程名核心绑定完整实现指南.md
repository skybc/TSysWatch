# 进程名核心绑定完整实现指南

## 功能概述

TSysWatch CPU 核心管理器现在完全支持进程名核心绑定功能，允许用户为特定进程名设置默认的 CPU 核心绑定配置，并在程序启动时自动加载和应用这些配置。

## 🎯 核心特性

### 1. 配置持久化
- **自动保存**：所有核心绑定配置都会保存到 `CpuCoreManager.ini` 文件
- **启动加载**：程序启动时自动加载所有配置，包括核心绑定映射
- **实时应用**：配置更改后可以立即应用到运行中的进程

### 2. 进程名映射系统
```ini
[ProcessCoreBinding]
# 游戏优化
game=0,2,4,6
steam=1,3

# 开发环境
code=0,1,2,3
node=4,5

# 多媒体
ffmpeg=0,2,4,6
vlc=1,3

# 浏览器
chrome=0,1
firefox=2,3
```

### 3. 优先级体系
1. **PID 核心绑定映射** (最高) - 针对特定进程实例
2. **进程名核心绑定映射** (高) - 针对所有同名进程
3. **PID 核心数映射** (中) - 传统核心数设置
4. **进程名核心数映射** (低) - 传统核心数设置
5. **默认核心数** (最低) - 系统默认

## 🔧 技术实现

### 配置文件结构
```ini
# CPU 核心数管理器配置文件
[General]
DefaultCoreCount=4
ScanIntervalSeconds=2
Enabled=true

[ProcessCoreBinding]
# 格式: 进程名=核心索引列表(用逗号分隔)
chrome=0,2,4
firefox=1,3,5
code=0,1,2,3

[Critical]
# 系统关键进程列表
Processes=System,csrss,wininit,winlogon,services,lsass,dwm,explorer
```

### 启动加载流程
1. **服务启动** → `CpuCoreManagerService.ExecuteAsync()`
2. **配置加载** → `CpuCoreConfigManager.LoadConfig()`
3. **配置应用** → `CpuCoreManager.UpdateConfig()`
4. **日志记录** → 详细记录所有加载的配置
5. **定时扫描** → 自动应用配置到新启动的进程

### 核心绑定逻辑
```csharp
// 优先级检查顺序
private (int coreCount, List<int>? coreBinding) GetTargetCoreConfiguration(int processId, string processName)
{
    

    // 2. 进程名核心绑定映射
    if (_config.ProcessCoreBindingMapping.TryGetValue(processName, out string? nameBinding))
    {
        var cores = ParseCoreBinding(nameBinding);
        if (cores.Count > 0) return (cores.Count, cores);
    }

    // 3. 其他配置...
}
```

## 🖥️ 用户界面功能

### 1. 进程列表增强
- **核心绑定列**：显示配置的绑定和当前状态
- **操作按钮**：
  - `核心数` - 设置核心数量
  - `绑定` - 设置具体核心绑定
  - `映射` - 添加到进程名映射

### 2. 配置管理界面
- **核心绑定映射管理**：
  - 添加新的进程名绑定
  - 编辑现有绑定
  - 删除绑定映射
  - 使用示例和帮助

### 3. 配置验证功能
- **实时验证**：检查核心索引有效性
- **冲突检测**：识别重复配置
- **性能建议**：提供优化建议
- **立即应用**：测试配置效果

### 4. 核心选择器
- **可视化选择**：复选框形式选择核心
- **快捷操作**：
  - 全选/全不选
  - 偶数核心选择
  - 奇数核心选择
- **实时预览**：显示选择结果

## 📊 使用场景与示例

### 游戏性能优化
```ini
[ProcessCoreBinding]
# 主游戏使用性能核心
game.exe=0,2,4,6
valorant.exe=0,2,4,6
csgo.exe=0,2,4,6

# 游戏平台使用后台核心
steam.exe=1,3
origin.exe=1,3
epicgameslauncher.exe=1,3

# 语音通讯软件
discord.exe=5,7
teamspeak3.exe=5,7
```

### 开发环境优化
```ini
[ProcessCoreBinding]
# 主要开发工具
code.exe=0,1,2,3
devenv.exe=0,1,2,3,4,5
intellij.exe=0,1,2,3

# 编译和构建工具
node.exe=4,5,6,7
dotnet.exe=4,5,6,7
msbuild.exe=4,5,6,7

# 数据库和服务
mysql.exe=6,7
redis-server.exe=6,7
```

### 多媒体工作流
```ini
[ProcessCoreBinding]
# 视频编辑
premiere.exe=0,1,2,3,4,5
aftereffects.exe=0,1,2,3,4,5
davinci.exe=0,1,2,3,4,5

# 音频处理
audacity.exe=6,7
reaper.exe=6,7

# 编码渲染
ffmpeg.exe=0,2,4,6
handbrake.exe=0,2,4,6
```

### 办公和浏览
```ini
[ProcessCoreBinding]
# 主浏览器
chrome.exe=0,1
msedge.exe=0,1

# 备用浏览器
firefox.exe=2,3

# 办公软件
winword.exe=4,5
excel.exe=4,5
powerpoint.exe=4,5

# 通讯软件
teams.exe=6,7
zoom.exe=6,7
```

## 🔍 监控和日志

### 启动日志示例
```
[INFO] CPU 核心管理器服务启动
[INFO] 管理员权限验证成功
[INFO] 调试权限启用成功
[INFO] 配置加载完成:
[INFO]   - 默认核心数: 4
[INFO]   - 扫描间隔: 2秒
[INFO]   - 功能启用: True
[INFO]   - 进程名核心数映射: 3 项
[INFO]   - PID核心数映射: 0 项
[INFO]   - 进程名核心绑定映射: 8 项
[INFO]   - PID核心绑定映射: 0 项
[INFO]   - 系统关键进程: 8 个
[INFO] 进程名核心绑定映射详情:
[INFO]   - chrome -> 核心 0,2
[INFO]   - firefox -> 核心 1,3
[INFO]   - code -> 核心 0,1,2,3
[INFO]   - game -> 核心 0,2,4,6
[INFO]   - ffmpeg -> 核心 0,2,4,6
[INFO]   - steam -> 核心 1,3
[INFO]   - discord -> 核心 5,7
[INFO]   - vlc -> 核心 4,5
[INFO] 定时扫描已启动，间隔: 2秒
```

### 运行时日志示例
```
[INFO] 进程亲和性设置 - PID:1234, 名称:chrome, 旧掩码:0xFF, 新掩码:0x5, 类型:CoreBinding, 核心绑定:0,2, 成功:True, 原因:核心绑定设置成功
[INFO] 进程亲和性设置 - PID:5678, 名称:firefox, 旧掩码:0xFF, 新掩码:0xA, 类型:CoreBinding, 核心绑定:1,3, 成功:True, 原因:核心绑定设置成功
```

## 🔒 安全和稳定性

### 权限管理
- **管理员权限检查**：所有核心绑定操作都需要管理员权限
- **系统进程保护**：自动跳过系统关键进程
- **进程访问验证**：检查进程句柄有效性

### 错误处理
- **配置验证**：启动时验证所有配置项
- **失败恢复**：单个进程设置失败不影响其他进程
- **详细日志**：记录所有操作和错误信息

### 性能优化
- **智能跳过**：相同掩码不重复设置
- **批量处理**：定时扫描批量应用配置
- **内存缓存**：配置信息缓存在内存中

## 🚀 API 接口

### 配置管理
```http
GET  /api/cpucore/config                    # 获取当前配置
POST /api/cpucore/config                    # 更新配置
POST /api/cpucore/config/validate           # 验证配置
POST /api/cpucore/config/apply              # 立即应用配置
```

### 核心绑定操作
```http
POST   /api/cpucore/process/{id}/binding              # 设置进程核心绑定
POST   /api/cpucore/mapping/process/binding           # 添加进程名绑定映射
DELETE /api/cpucore/mapping/process/binding/{name}    # 删除进程名绑定映射
GET    /api/cpucore/available-cores                   # 获取可用核心列表
```

### 进程管理
```http
GET  /api/cpucore/processes                 # 获取进程列表
POST /api/cpucore/process/{id}/cores/{count} # 设置进程核心数
POST /api/cpucore/scan                      # 手动触发扫描
GET  /api/cpucore/logs                      # 获取操作日志
```

## 🔄 版本兼容性

### 向后兼容
- ✅ 旧的核心数设置功能完全保留
- ✅ 现有配置文件可以正常加载
- ✅ 原有 API 接口保持不变

### 新功能扩展
- ✅ 核心绑定配置与核心数配置并存
- ✅ 优先级系统确保功能协调工作
- ✅ 新的配置节可选，不影响基本功能

## 📝 最佳实践

### 配置建议
1. **合理分配**：避免所有程序都绑定到同一核心
2. **性能核心优先**：将重要程序绑定到性能较好的核心
3. **后台程序分离**：将后台程序绑定到独立核心
4. **定期检查**：监控日志确保配置正确应用

### 维护建议
1. **备份配置**：定期备份 `CpuCoreManager.ini` 文件
2. **监控日志**：关注启动和运行时日志
3. **测试验证**：使用配置验证功能检查设置
4. **性能监控**：观察系统性能变化

这个完整的实现为用户提供了强大而灵活的 CPU 核心管理能力，通过进程名绑定实现了自动化的性能优化。