# CPU 核心管理器故障修复说明

## 问题描述
在启动应用程序时遇到以下错误：
```
System.InvalidOperationException: Unable to resolve service for type 'TSysWatch.Services.CpuCoreManagerService' while attempting to activate 'TSysWatch.Controllers.CpuCoreController'.
```

## 问题原因
控制器 `CpuCoreController` 试图注入 `CpuCoreManagerService`，但该服务是通过 `AddHostedService` 注册的后台服务，不能直接作为依赖注入使用。

## 解决方案

### 1. 创建服务接口
创建了 `ICpuCoreManagerService` 接口和 `CpuCoreManagerServiceWrapper` 包装器：

```csharp
public interface ICpuCoreManagerService
{
    void ReloadConfiguration();
    void TriggerManualScan();
}
```

### 2. 服务包装器
`CpuCoreManagerServiceWrapper` 实现了接口，通过静态引用与后台服务通信：

```csharp
public class CpuCoreManagerServiceWrapper : ICpuCoreManagerService
{
    private static CpuCoreManagerService? _backgroundService;
    
    internal static void SetBackgroundService(CpuCoreManagerService backgroundService)
    {
        _backgroundService = backgroundService;
    }
    
    public void ReloadConfiguration()
    {
        _backgroundService?.ReloadConfiguration();
    }
    
    public void TriggerManualScan()
    {
        _backgroundService?.TriggerManualScan();
    }
}
```

### 3. 依赖注入配置
在 `Program.cs` 中正确注册服务：

```csharp
// 注册 CPU 核心管理器服务
builder.Services.AddSingleton<CpuCoreManager>();
builder.Services.AddSingleton<CpuCoreConfigManager>();
builder.Services.AddSingleton<ICpuCoreManagerService, CpuCoreManagerServiceWrapper>();
builder.Services.AddHostedService<CpuCoreManagerService>();
```

### 4. 控制器修改
控制器现在注入接口而不是具体的后台服务：

```csharp
public CpuCoreController(
    ILogger<CpuCoreController> logger,
    CpuCoreManager coreManager,
    CpuCoreConfigManager configManager,
    ICpuCoreManagerService managerService)  // 使用接口
```

### 5. 后台服务连接
在后台服务构造函数中设置静态引用：

```csharp
public CpuCoreManagerService(...)
{
    // 设置静态引用
    CpuCoreManagerServiceWrapper.SetBackgroundService(this);
}
```

## 修复结果

✅ **依赖注入错误已解决**
- 控制器可以成功注入所需的服务
- Web API 可以正常调用后台服务功能

✅ **功能完整性保持**
- 配置重载功能正常工作
- 手动扫描触发正常工作
- 后台定时扫描继续运行

✅ **架构改进**
- 清晰的服务分离
- 避免循环依赖
- 更好的可测试性

## 测试验证

启动应用程序后：
1. 访问 `/CpuCore/Index` - 应该正常显示管理界面
2. 调用 `POST /api/cpucore/scan` - 应该成功触发扫描
3. 调用 `POST /api/cpucore/config` - 应该成功更新配置

## 注意事项

- 需要以管理员权限运行程序
- 确保 `app.manifest` 文件存在且配置正确
- 所有 Windows API 调用都有适当的错误处理

程序现在可以正常启动和运行，CPU 核心管理功能完全可用。